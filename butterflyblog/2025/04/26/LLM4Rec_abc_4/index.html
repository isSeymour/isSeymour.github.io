<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>大模型推荐系统（4）直接推荐范式 | isSeymour</title><meta name="author" content="isSeymour"><meta name="copyright" content="isSeymour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强 数据集来源：  MIND 新闻数据集对应论文MIND: A Large-scale Dataset for News Recommendation Amazon 电商数据集  注：大型文件包工具git-lfs、强化学习训练工具trl  直接推荐范式  利用大模型的上下文学习进行推荐  1、上下文学习推荐基本原理  当模型参数规模">
<meta property="og:type" content="article">
<meta property="og:title" content="大模型推荐系统（4）直接推荐范式">
<meta property="og:url" content="https://isseymour.github.io/butterflyblog/2025/04/26/LLM4Rec_abc_4/index.html">
<meta property="og:site_name" content="isSeymour">
<meta property="og:description" content="阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强 数据集来源：  MIND 新闻数据集对应论文MIND: A Large-scale Dataset for News Recommendation Amazon 电商数据集  注：大型文件包工具git-lfs、强化学习训练工具trl  直接推荐范式  利用大模型的上下文学习进行推荐  1、上下文学习推荐基本原理  当模型参数规模">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png">
<meta property="article:published_time" content="2025-04-26T10:00:00.000Z">
<meta property="article:modified_time" content="2025-04-26T10:00:00.000Z">
<meta property="article:author" content="isSeymour">
<meta property="article:tag" content="LLM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/IC1011.ico"><link rel="canonical" href="https://isseymour.github.io/butterflyblog/2025/04/26/LLM4Rec_abc_4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/butterflyblog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/butterflyblog/',
  algolia: undefined,
  localSearch: {"path":"/butterflyblog/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '大模型推荐系统（4）直接推荐范式',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-26 18:00:00'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/butterflyblog/code/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/T6.jpg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/butterflyblog/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/butterflyblog/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/butterflyblog/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> 总览</span></a></li><li><a class="site-page child" href="/butterflyblog/tags/"><i class="fa-fw fa-sharp fa-solid fa-hashtag"></i><span> 标签</span></a></li><li><a class="site-page child" href="/butterflyblog/categories/"><i class="fa-fw fa-sharp fa-solid fa-folder"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-list"></i><span> 功能</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/ctf/"><i class="fa-fw fa-solid fa-shield-halved"></i><span> CTF</span></a></li><li><a class="site-page child" href="/butterflyblog/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/butterflyblog/tools/"><i class="fa-fw fa-solid fa-screwdriver-wrench"></i><span> 下载</span></a></li><li><a class="site-page child" href="/butterflyblog/link/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-university"></i><span> 算法</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/algorithm/hot100/"><i class="fa-fw fa-solid fa-fire"></i><span> HOT100</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/labuladong/"><i class="fa-fw fa-solid fa-coffee"></i><span> labuladong</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/luogu/"><i class="fa-fw fa-solid fa-magnet"></i><span> 洛谷</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/template/"><i class="fa-fw fa-solid fa-code"></i><span> Template</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-plane"></i><span> 旅途</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/journey/english/"><i class="fa-fw fa-solid fa-globe"></i><span> 英语</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/RecSys/"><i class="fa-fw fa-solid fa-thumbs-up"></i><span> RecSys</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-regular fa-user"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/about/"><i class="fa-fw fa-regular fa-user"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/butterflyblog/message/"><i class="fa-fw fa-solid fa-message"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/butterflyblog/develop/"><i class="fa-fw fa-brands fa-windows"></i><span> 开发日志</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png')"><nav id="nav"><span id="blog-info"><a href="/butterflyblog/" title="isSeymour"><span class="site-name">isSeymour</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> 总览</span></a></li><li><a class="site-page child" href="/butterflyblog/tags/"><i class="fa-fw fa-sharp fa-solid fa-hashtag"></i><span> 标签</span></a></li><li><a class="site-page child" href="/butterflyblog/categories/"><i class="fa-fw fa-sharp fa-solid fa-folder"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-list"></i><span> 功能</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/ctf/"><i class="fa-fw fa-solid fa-shield-halved"></i><span> CTF</span></a></li><li><a class="site-page child" href="/butterflyblog/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/butterflyblog/tools/"><i class="fa-fw fa-solid fa-screwdriver-wrench"></i><span> 下载</span></a></li><li><a class="site-page child" href="/butterflyblog/link/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-university"></i><span> 算法</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/algorithm/hot100/"><i class="fa-fw fa-solid fa-fire"></i><span> HOT100</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/labuladong/"><i class="fa-fw fa-solid fa-coffee"></i><span> labuladong</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/luogu/"><i class="fa-fw fa-solid fa-magnet"></i><span> 洛谷</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/template/"><i class="fa-fw fa-solid fa-code"></i><span> Template</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-plane"></i><span> 旅途</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/journey/english/"><i class="fa-fw fa-solid fa-globe"></i><span> 英语</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/RecSys/"><i class="fa-fw fa-solid fa-thumbs-up"></i><span> RecSys</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-regular fa-user"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/about/"><i class="fa-fw fa-regular fa-user"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/butterflyblog/message/"><i class="fa-fw fa-solid fa-message"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/butterflyblog/develop/"><i class="fa-fw fa-brands fa-windows"></i><span> 开发日志</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">大模型推荐系统（4）直接推荐范式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-26T10:00:00.000Z" title="发表于 2025-04-26 18:00:00">2025-04-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-26T10:00:00.000Z" title="更新于 2025-04-26 18:00:00">2025-04-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/butterflyblog/categories/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/">推荐系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="大模型推荐系统（4）直接推荐范式"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note danger no-icon flat"><p>阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强<br>
数据集来源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://msnews.github.io">MIND 新闻数据集</a>对应论文<a target="_blank" rel="noopener" href="https://msnews.github.io/assets/doc/ACL2020_MIND.pdf">MIND: A Large-scale Dataset for News Recommendation</a></li>
<li><a target="_blank" rel="noopener" href="https://cseweb.ucsd.edu/~jmcauley/datasets/amazon_v2/">Amazon 电商数据集</a></li>
</ul>
<p>注：大型文件包工具<a target="_blank" rel="noopener" href="https://git-lfs.com">git-lfs</a>、强化学习训练工具<a target="_blank" rel="noopener" href="https://github.com/huggingface/trl">trl</a></p>
</div>
<h1>直接推荐范式</h1>
<blockquote>
<p>利用大模型的上下文学习进行推荐</p>
</blockquote>
<h2 id="1、上下文学习推荐基本原理">1、上下文学习推荐基本原理</h2>
<ul>
<li>当模型参数规模足够大时，大模型本身就具备非常强的泛化能力。基本能够直接使用这类大模型进行个性化推荐。</li>
<li>只需要使用特定提示词激发大模型的推荐能力就可以将其用于下游推荐任务，而无需进行任何微调，这种能力就叫做上下文学习，分为 zero-shot 和 few-shot 的。</li>
<li>另外，可以分解任务，逐步解决，叫做思维链能力。</li>
<li>注意，在经典的<code>召回-&gt;排序</code>推荐范式下，直接推荐范式其实是利用大模型进行<code>排序</code>，即对召回的候选物品进行排序。召回阶段使用其他推荐算法。</li>
</ul>
<h2 id="2、案例">2、案例</h2>
<h3 id="2-1-LLMRank-实现">2.1 LLMRank 实现</h3>
<ul>
<li>构造用户历史交互序列（方法：顺序提示词、关注最近行为的提示词、上下文学习提示词）</li>
<li>构造抽取候选集（方法：多路召回后，生成不同顺序。同时使用自举法减少位置偏差）</li>
<li>使用大模型进行排序</li>
<li>解析输出</li>
</ul>
<p>注：实际效果：</p>
<ol>
<li>可以个性化排序，但很难感知给定历史交互的顺序。</li>
<li>专门提示词的确可以改善排序效果。</li>
<li>大模型优于 zero-shot 推荐方法。</li>
<li>大模型排序存在位置偏见和热门偏见，需提示词或自举法缓解。</li>
</ol>
<h3 id="2-2-多任务实现">2.2 多任务实现</h3>
<ul>
<li>直接设计一组提示词在 5 项推荐任务：
<ol>
<li>评分预测</li>
<li>序列推荐</li>
<li>直接推荐</li>
<li>解释生成</li>
<li>评论摘要</li>
</ol>
</li>
<li>做法：
<ol>
<li>构造特定任务的提示词</li>
<li>利用 chatGPT 生成推荐结果</li>
<li>优化推荐结果</li>
</ol>
</li>
</ul>
<h3 id="2-3-NIR实现">2.3 NIR实现</h3>
<ul>
<li>Next-Item Recommendation 框架</li>
<li>做法：
<ol>
<li>构建用户兴趣</li>
<li>代表性电影生成</li>
<li>电影推荐</li>
</ol>
</li>
</ul>
<h2 id="3、上下文学习推荐代码实现">3、上下文学习推荐代码实现</h2>
<h3 id="3-1-数据准备">3.1 数据准备</h3>
<p>构建数据集代码<code>generate_json_data.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">按照如下格式构建验证数据集：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;instruction&quot;: &quot;You are a recommendation system expert who provides personalized recommendations to users based on the background information provided.&quot;, </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;input&quot;: &quot;I&#x27;ve browsed the following news in the past in order:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&#x27;&#x27;Wheel Of Fortune&#x27; Guest Delivers Hilarious, Off The Rails Introduction&#x27;,&#x27;Hard Rock Hotel New Orleans collapse: Former site engineer weighs in&#x27;,&#x27;Felicity Huffman begins prison sentence for college admissions scam&#x27;,&#x27;Outer Banks storms unearth old shipwreck from &#x27;Graveyard of the Atlantic&#x27;&#x27;,&#x27;Tiffany&#x27;s is selling a holiday advent calendar for $112,000&#x27;,&#x27;This restored 1968 Winnebago is beyond adorable&#x27;,&#x27;Lori Loughlin Is &#x27;Absolutely Terrified&#x27; After Being Hit With New Charge&#x27;,&#x27;Bruce Willis brought Demi Moore to tears after reading her book&#x27;,&#x27;Celebrity kids then and now: See how they&#x27;ve grown&#x27;,&#x27;Felicity Huffman Smiles as She Begins Community Service Following Prison Release&#x27;,&#x27;Queen Elizabeth Finally Had Her Dream Photoshoot, Thanks to Royal Dresser Angela Kelly&#x27;,&#x27;Hundreds of thousands of people in California are downriver of a dam that &#x27;could fail&#x27;&#x27;,&#x27;Alexandria Ocasio-Cortez &#x27;sincerely&#x27; apologizes for blocking ex-Brooklyn politician on Twitter, settles federal lawsuit&#x27;,&#x27;The Rock&#x27;s Gnarly Palm Is a Testament to Life Without Lifting Gloves&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Then if I ask you to recommend a new news to me according to my browsing history, you should recommend &#x27;Donald Trump Jr. reflects on explosive &#x27;View&#x27; chat: &#x27;I don&#x27;t think they like me much anymore&#x27;&#x27; and now that I&#x27;ve just browsed &#x27;Donald Trump Jr. reflects on explosive &#x27;View&#x27; chat: &#x27;I don&#x27;t think they like me much anymore&#x27;&#x27;, there are 22 candidate news that I can browse next:</span></span><br><span class="line"><span class="string">1. &#x27;Browns apologize to Mason Rudolph, call Myles Garrett&#x27;s actions &#x27;unacceptable&#x27;&#x27;,</span></span><br><span class="line"><span class="string">2. &#x27;I&#x27;ve been writing about tiny homes for a year and finally spent 2 nights in a 300-foot home to see what it&#x27;s all about   here&#x27;s how it went&#x27;,</span></span><br><span class="line"><span class="string">3. &#x27;Opinion: Colin Kaepernick is about to get what he deserves: a chance&#x27;,</span></span><br><span class="line"><span class="string">4. &#x27;The Kardashians Face Backlash Over &#x27;Insensitive&#x27; Family Food Fight in KUWTK Clip&#x27;,</span></span><br><span class="line"><span class="string">5. &#x27;THEN AND NOW: What all your favorite &#x27;90s stars are doing today&#x27;,6. &#x27;Report: Police investigating woman&#x27;s death after Redskins&#x27; player Montae Nicholson took her to hospital&#x27;,</span></span><br><span class="line"><span class="string">7. &#x27;U.S. Troops Will Die If They Remain in Syria, Bashar Al-Assad Warns&#x27;,</span></span><br><span class="line"><span class="string">8. &#x27;3 Indiana judges suspended after a night of drinking turned into a White Castle brawl&#x27;,</span></span><br><span class="line"><span class="string">9. &#x27;Cows swept away by Hurricane Dorian found alive   but how?&#x27;,</span></span><br><span class="line"><span class="string">10. &#x27;Surviving Santa Clarita school shooting victims on road to recovery: Latest&#x27;,</span></span><br><span class="line"><span class="string">11. &#x27;The Unlikely Star of My Family&#x27;s Thanksgiving Table&#x27;,</span></span><br><span class="line"><span class="string">12. &#x27;Meghan Markle and Hillary Clinton Secretly Spent the Afternoon Together at Frogmore Cottage&#x27;,</span></span><br><span class="line"><span class="string">13. &#x27;Former North Carolina State, NBA player Anthony Grundy dies in stabbing, police say&#x27;,</span></span><br><span class="line"><span class="string">14. &#x27;85 Thanksgiving Recipes You Can Make Ahead&#x27;,</span></span><br><span class="line"><span class="string">15. &#x27;Survivor Contestants Missy Byrd and Elizabeth Beisel Apologize For Their Actions&#x27;,</span></span><br><span class="line"><span class="string">16. &#x27;Pete Davidson, Kaia Gerber Are Dating, Trying to Stay &#x27;Low Profile&#x27;&#x27;,</span></span><br><span class="line"><span class="string">17. &#x27;There&#x27;s a place in the US where its been over 80 degrees since March&#x27;,</span></span><br><span class="line"><span class="string">18. &#x27;Taylor Swift Rep Hits Back at Big Machine, Claims She&#x27;s Actually Owed $7.9 Million in Unpaid Royalties&#x27;,</span></span><br><span class="line"><span class="string">19. &#x27;The most talked about movie moments of the 2010s&#x27;,</span></span><br><span class="line"><span class="string">20. &#x27;Belichick mocks social media in comments on Garrett incident&#x27;,</span></span><br><span class="line"><span class="string">21. &#x27;13 Reasons Why&#x27;s Christian Navarro Slams Disney for Casting &#x27;the White Guy&#x27; in The Little Mermaid&#x27;,</span></span><br><span class="line"><span class="string">22. &#x27;66 Cool Tech Gifts Anyone Would Be Thrilled to Receive&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please select some news that I would like to browse next according to my browsing history. Please think step by step.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please show me your results. Split your output with line break. You MUST select from the given candidate news. You can not generate news that are not in the given candidate list.&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;output&quot;: &quot;[&#x27;Opinion: Colin Kaepernick is about to get what he deserves: a chance&#x27;\n]&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">instruction = (<span class="string">&quot;You are a recommendation system expert who provides personalized recommendations to users based on &quot;</span></span><br><span class="line">               <span class="string">&quot;the background information provided.&quot;</span>)</span><br><span class="line"></span><br><span class="line">news_dict = &#123;&#125;  <span class="comment"># 从news.tsv获取每个新闻id到标题的映射字典。</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../data/mind/news.tsv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    reader = csv.reader(file, delimiter=<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        news_id = row[<span class="number">0</span>]</span><br><span class="line">        news_title = row[<span class="number">3</span>]</span><br><span class="line">        news_dict[news_id] = news_title</span><br><span class="line"></span><br><span class="line">data_list = []  <span class="comment"># 利用behaviors.tsv数据获取用户喜欢和不喜欢的新闻</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../data/mind/behaviors.tsv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    reader = csv.reader(file, delimiter=<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        history = row[<span class="number">3</span>]</span><br><span class="line">        impression = row[<span class="number">4</span>]</span><br><span class="line">        history_list = history.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        impre_list = impression.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(history_list) &gt;= <span class="number">6</span> <span class="keyword">and</span> <span class="built_in">len</span>(impre_list) &gt;= <span class="number">10</span>:  <span class="comment"># 用户至少要有6个点击历史和10个曝光历史</span></span><br><span class="line">            his = []</span><br><span class="line">            <span class="keyword">for</span> news_id <span class="keyword">in</span> history_list[:-<span class="number">1</span>]:</span><br><span class="line">                title = news_dict[news_id]</span><br><span class="line">                his.append(title)</span><br><span class="line">            last_view_id = history_list[-<span class="number">1</span>]</span><br><span class="line">            last_view = news_dict[last_view_id]</span><br><span class="line">            preference = []</span><br><span class="line">            candidate = []</span><br><span class="line">            index = <span class="number">1</span></span><br><span class="line">            <span class="keyword">for</span> impre <span class="keyword">in</span> impre_list:</span><br><span class="line">                [impre_id, action] = impre.split(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">                title = news_dict[impre_id]</span><br><span class="line">                candidate.append(<span class="built_in">str</span>(index) + <span class="string">&quot;. &quot;</span> + title + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">int</span>(action) == <span class="number">1</span>:</span><br><span class="line">                    preference.append(title + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="built_in">input</span> = (<span class="string">&quot;I’ve browsed the following news in the past in order:\n\n&quot;</span> +</span><br><span class="line">                     <span class="string">&quot;[&quot;</span> + <span class="string">&#x27;,&#x27;</span>.join(his) + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                     <span class="string">&quot;Then if I ask you to recommend a new news to me according to my browsing history, &quot;</span></span><br><span class="line">                     <span class="string">&quot;you should recommend &quot;</span> + last_view + <span class="string">&quot; and now that I&#x27;ve just browsed &quot;</span> + last_view + <span class="string">&quot;, &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;there are &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(impre_list)) + <span class="string">&quot; candidate news that I can browse next:&quot;</span> +</span><br><span class="line">                     <span class="string">&#x27;,&#x27;</span>.join(candidate) + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                     <span class="string">&quot;Please select some news that I would like to browse next according to my browsing history. &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;Please think step by step.\n\n&quot;</span> +</span><br><span class="line">                     <span class="string">&quot;Please show me your results. Split your output with line break. You MUST select from the given &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;candidate news. You can not generate news that are not in the given candidate list.&quot;</span></span><br><span class="line">                     )</span><br><span class="line">            output = <span class="string">&quot;[\n&quot;</span> + <span class="string">&#x27;,&#x27;</span>.join(preference) + <span class="string">&quot;\n]&quot;</span></span><br><span class="line">            res_dic = &#123;</span><br><span class="line">                <span class="string">&quot;instruction&quot;</span>: instruction,</span><br><span class="line">                <span class="string">&quot;input&quot;</span>: <span class="built_in">input</span>,</span><br><span class="line">                <span class="string">&quot;output&quot;</span>: output</span><br><span class="line">            &#125;</span><br><span class="line">            data_list.append(res_dic)</span><br><span class="line"></span><br><span class="line">res = json.dumps(data_list, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">user_sequence_path = <span class="string">&quot;../data/mind/test.json&quot;</span>  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(user_sequence_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(res)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-2-上下文学习推荐">3.2 上下文学习推荐</h3>
<p>有两种方法：</p>
<ol>
<li>单步骤上下文学习推荐</li>
<li>多步骤上下文学习推荐</li>
</ol>
<p>单步骤<code>icl_rec.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks <span class="keyword">import</span> StreamingStdOutCallbackHandler</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.prompts.chat <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms <span class="keyword">import</span> LlamaCpp</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.huggingface_pipeline <span class="keyword">import</span> HuggingFacePipeline</span><br><span class="line"><span class="keyword">from</span> mlx_lm <span class="keyword">import</span> load, generate</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModelForCausalLM, pipeline, TextStreamer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">icl_rec</span>(<span class="params"></span></span><br><span class="line"><span class="params">        model_path: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        icl_type: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        instruction: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        prompt: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        temperature: <span class="built_in">float</span> = <span class="number">0.1</span>,</span></span><br><span class="line"><span class="params">        top_p: <span class="built_in">float</span> = <span class="number">0.95</span>,</span></span><br><span class="line"><span class="params">        ctx: <span class="built_in">int</span> = <span class="number">13000</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    针对单个prompt为用户进行icl推荐</span></span><br><span class="line"><span class="string">    :param model_path: 模型地址</span></span><br><span class="line"><span class="string">    :param icl_type: icl推理类型，我们实现了ollama、llamacpp、transformers、mlx 4类icl推理方法</span></span><br><span class="line"><span class="string">    :param instruction: 指令</span></span><br><span class="line"><span class="string">    :param prompt: 提示词</span></span><br><span class="line"><span class="string">    :param temperature: 大模型温度系数</span></span><br><span class="line"><span class="string">    :param top_p: 大模型的top_p</span></span><br><span class="line"><span class="string">    :param ctx: 输出token长度</span></span><br><span class="line"><span class="string">    :return: 无</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> instruction:</span><br><span class="line">        instruction = (<span class="string">&quot;You are a recommendation system expert who provides personalized recommendations to users &quot;</span></span><br><span class="line">                       <span class="string">&quot;based on the background information provided.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> prompt:</span><br><span class="line">        prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &quot;I&#x27;ve browsed the following news in the past in order:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        [&#x27;&#x27;Wheel Of Fortune&#x27; Guest Delivers Hilarious, Off The Rails Introduction&#x27;,&#x27;Hard Rock Hotel New Orleans collapse: Former site engineer weighs in&#x27;,&#x27;Felicity Huffman begins prison sentence for college admissions scam&#x27;,&#x27;Outer Banks storms unearth old shipwreck from &#x27;Graveyard of the Atlantic&#x27;&#x27;,&#x27;Tiffany&#x27;s is selling a holiday advent calendar for $112,000&#x27;,&#x27;This restored 1968 Winnebago is beyond adorable&#x27;,&#x27;Lori Loughlin Is &#x27;Absolutely Terrified&#x27; After Being Hit With New Charge&#x27;,&#x27;Bruce Willis brought Demi Moore to tears after reading her book&#x27;,&#x27;Celebrity kids then and now: See how they&#x27;ve grown&#x27;,&#x27;Felicity Huffman Smiles as She Begins Community Service Following Prison Release&#x27;,&#x27;Queen Elizabeth Finally Had Her Dream Photoshoot, Thanks to Royal Dresser Angela Kelly&#x27;,&#x27;Hundreds of thousands of people in California are downriver of a dam that &#x27;could fail&#x27;&#x27;,&#x27;Alexandria Ocasio-Cortez &#x27;sincerely&#x27; apologizes for blocking ex-Brooklyn politician on Twitter, settles federal lawsuit&#x27;,&#x27;The Rock&#x27;s Gnarly Palm Is a Testament to Life Without Lifting Gloves&#x27;]</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Then if I ask you to recommend a new news to me according to my browsing history, you should recommend &#x27;Donald Trump Jr. reflects on explosive &#x27;View&#x27; chat: &#x27;I don&#x27;t think they like me much anymore&#x27;&#x27; and now that I&#x27;ve just browsed &#x27;Donald Trump Jr. reflects on explosive &#x27;View&#x27; chat: &#x27;I don&#x27;t think they like me much anymore&#x27;&#x27;, there are 22 candidate news that I can browse next:</span></span><br><span class="line"><span class="string">        1. &#x27;Browns apologize to Mason Rudolph, call Myles Garrett&#x27;s actions &#x27;unacceptable&#x27;&#x27;,</span></span><br><span class="line"><span class="string">        2. &#x27;I&#x27;ve been writing about tiny homes for a year and finally spent 2 nights in a 300-foot home to see what it&#x27;s all about   here&#x27;s how it went&#x27;,</span></span><br><span class="line"><span class="string">        3. &#x27;Opinion: Colin Kaepernick is about to get what he deserves: a chance&#x27;,</span></span><br><span class="line"><span class="string">        4. &#x27;The Kardashians Face Backlash Over &#x27;Insensitive&#x27; Family Food Fight in KUWTK Clip&#x27;,</span></span><br><span class="line"><span class="string">        5. &#x27;THEN AND NOW: What all your favorite &#x27;90s stars are doing today&#x27;,6. &#x27;Report: Police investigating woman&#x27;s death after Redskins&#x27; player Montae Nicholson took her to hospital&#x27;,</span></span><br><span class="line"><span class="string">        7. &#x27;U.S. Troops Will Die If They Remain in Syria, Bashar Al-Assad Warns&#x27;,</span></span><br><span class="line"><span class="string">        8. &#x27;3 Indiana judges suspended after a night of drinking turned into a White Castle brawl&#x27;,</span></span><br><span class="line"><span class="string">        9. &#x27;Cows swept away by Hurricane Dorian found alive   but how?&#x27;,</span></span><br><span class="line"><span class="string">        10. &#x27;Surviving Santa Clarita school shooting victims on road to recovery: Latest&#x27;,</span></span><br><span class="line"><span class="string">        11. &#x27;The Unlikely Star of My Family&#x27;s Thanksgiving Table&#x27;,</span></span><br><span class="line"><span class="string">        12. &#x27;Meghan Markle and Hillary Clinton Secretly Spent the Afternoon Together at Frogmore Cottage&#x27;,</span></span><br><span class="line"><span class="string">        13. &#x27;Former North Carolina State, NBA player Anthony Grundy dies in stabbing, police say&#x27;,</span></span><br><span class="line"><span class="string">        14. &#x27;85 Thanksgiving Recipes You Can Make Ahead&#x27;,</span></span><br><span class="line"><span class="string">        15. &#x27;Survivor Contestants Missy Byrd and Elizabeth Beisel Apologize For Their Actions&#x27;,</span></span><br><span class="line"><span class="string">        16. &#x27;Pete Davidson, Kaia Gerber Are Dating, Trying to Stay &#x27;Low Profile&#x27;&#x27;,</span></span><br><span class="line"><span class="string">        17. &#x27;There&#x27;s a place in the US where its been over 80 degrees since March&#x27;,</span></span><br><span class="line"><span class="string">        18. &#x27;Taylor Swift Rep Hits Back at Big Machine, Claims She&#x27;s Actually Owed $7.9 Million in Unpaid Royalties&#x27;,</span></span><br><span class="line"><span class="string">        19. &#x27;The most talked about movie moments of the 2010s&#x27;,</span></span><br><span class="line"><span class="string">        20. &#x27;Belichick mocks social media in comments on Garrett incident&#x27;,</span></span><br><span class="line"><span class="string">        21. &#x27;13 Reasons Why&#x27;s Christian Navarro Slams Disney for Casting &#x27;the White Guy&#x27; in The Little Mermaid&#x27;,</span></span><br><span class="line"><span class="string">        22. &#x27;66 Cool Tech Gifts Anyone Would Be Thrilled to Receive&#x27;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Please select some news that I would like to browse next according to my browsing history. Please think step by step.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Please show me your results. Split your output with line break. You MUST select from the given candidate news. You can not generate news that are not in the given candidate list.&quot;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> (</span><br><span class="line">        icl_type</span><br><span class="line">    ), <span class="string">&quot;Please specify a --icl_type, e.g. --icl_type=&#x27;ollama&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> icl_type == <span class="string">&quot;ollama&quot;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        利用Ollama框架将大模型封装成类似ChatGPT接口规范的API服务，直接通过调用接口来实现大模型icl推荐</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        url = <span class="string">&quot;http://localhost:11434/api/chat&quot;</span>  <span class="comment"># Ollama的api地址</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;model&quot;</span>: <span class="string">&quot;yi:34b-chat&quot;</span>,  <span class="comment"># Ollama安装的模型名</span></span><br><span class="line">            <span class="string">&quot;options&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;temperature&quot;</span>: temperature,</span><br><span class="line">                <span class="string">&quot;top_p&quot;</span>: top_p,</span><br><span class="line">                <span class="string">&quot;num_ctx&quot;</span>: ctx,</span><br><span class="line">                <span class="string">&quot;num_gpu&quot;</span>: <span class="number">128</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: prompt</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.post(url=url, json=data, stream=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> response.iter_content(chunk_size=<span class="literal">None</span>, decode_unicode=<span class="literal">True</span>):</span><br><span class="line">            j = json.loads(chunk.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span>(j[<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>], end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> icl_type == <span class="string">&quot;llamacpp&quot;</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> model_path:</span><br><span class="line">            model_path = <span class="string">&quot;/Users/liuqiang/Desktop/code/llm/models/gguf/qwen1.5-72b-chat-q5_k_m.gguf&quot;</span></span><br><span class="line">        callback = StreamingStdOutCallbackHandler()</span><br><span class="line">        n_gpu_layers = <span class="number">128</span>  <span class="comment"># Change this value based on your model and your GPU VRAM pool.</span></span><br><span class="line">        n_batch = <span class="number">4096</span>  <span class="comment"># Should be between 1 and n_ctx, consider the amount of RAM of your Apple Silicon Chip.</span></span><br><span class="line">        llm = LlamaCpp(</span><br><span class="line">            streaming=<span class="literal">True</span>,</span><br><span class="line">            model_path=model_path,</span><br><span class="line">            n_gpu_layers=n_gpu_layers,</span><br><span class="line">            n_batch=n_batch,</span><br><span class="line">            f16_kv=<span class="literal">True</span>,  <span class="comment"># MUST set to True, otherwise you will run into problem after a couple of calls</span></span><br><span class="line">            temperature=temperature,</span><br><span class="line">            top_p=top_p,</span><br><span class="line">            n_ctx=ctx,</span><br><span class="line">            callbacks=[callback],</span><br><span class="line">            verbose=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        system = [(<span class="string">&quot;system&quot;</span>, instruction),</span><br><span class="line">                  (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>)]</span><br><span class="line">        template = ChatPromptTemplate.from_messages(system)</span><br><span class="line">        chain = LLMChain(prompt=template, llm=llm)</span><br><span class="line">        chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: prompt&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> icl_type == <span class="string">&quot;transformers&quot;</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> model_path:</span><br><span class="line">            model_path = <span class="string">&quot;/Users/liuqiang/Desktop/code/llm/models/Yi-34B-Chat&quot;</span></span><br><span class="line">        tokenizer = AutoTokenizer.from_pretrained(model_path)</span><br><span class="line">        model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">            model_path,</span><br><span class="line">            trust_remote_code=<span class="literal">True</span>,</span><br><span class="line">            torch_dtype=torch.float16,</span><br><span class="line">            device_map=<span class="string">&quot;mps&quot;</span>,</span><br><span class="line">            use_cache=<span class="literal">True</span>,</span><br><span class="line">        )</span><br><span class="line">        model = model.to(<span class="string">&quot;mps&quot;</span>)</span><br><span class="line">        streamer = TextStreamer(tokenizer)</span><br><span class="line">        pipe = pipeline(</span><br><span class="line">            <span class="string">&quot;text-generation&quot;</span>,</span><br><span class="line">            model=model,</span><br><span class="line">            tokenizer=tokenizer,</span><br><span class="line">            streamer=streamer,</span><br><span class="line">            max_length=<span class="number">13000</span>,</span><br><span class="line">            temperature=temperature,</span><br><span class="line">            pad_token_id=tokenizer.eos_token_id,</span><br><span class="line">            top_p=top_p,</span><br><span class="line">            repetition_penalty=<span class="number">1.15</span>,</span><br><span class="line">            do_sample=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        llm = HuggingFacePipeline(pipeline=pipe)</span><br><span class="line">        system = [(<span class="string">&quot;system&quot;</span>, instruction),</span><br><span class="line">                  (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>)]</span><br><span class="line">        template = ChatPromptTemplate.from_messages(system)</span><br><span class="line">        chain = LLMChain(prompt=template, llm=llm)</span><br><span class="line">        chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: prompt&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> icl_type == <span class="string">&quot;mlx&quot;</span>:  <span class="comment"># 苹果的MLX框架</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> model_path:</span><br><span class="line">            model_path = <span class="string">&quot;/Users/liuqiang/Desktop/code/llm/models/Yi-34B-Chat&quot;</span></span><br><span class="line">        model, tokenizer = load(model_path)</span><br><span class="line">        response = generate(</span><br><span class="line">            model,</span><br><span class="line">            tokenizer,</span><br><span class="line">            prompt=prompt,</span><br><span class="line">            temp=temperature,</span><br><span class="line">            max_tokens=<span class="number">10000</span>,</span><br><span class="line">            verbose=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;the case not implemented!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">icl_rec_batch</span>(<span class="params">validation_path: <span class="built_in">str</span>, icl_type=<span class="string">&#x27;llamacpp&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        针对从训练数据构建的测试集，逐条为用户进行icl推理，你可以跟真实值（即output）对比，查看大模型icl推荐的效果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = load_dataset(<span class="string">&quot;json&quot;</span>, data_files=validation_path)</span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data[<span class="string">&#x27;train&#x27;</span>]:</span><br><span class="line">        instruction = row[<span class="string">&#x27;instruction&#x27;</span>]</span><br><span class="line">        <span class="built_in">input</span> = row[<span class="string">&#x27;input&#x27;</span>]</span><br><span class="line">        output = row[<span class="string">&#x27;output&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(index) + <span class="string">&quot; : --------------------&quot;</span>)</span><br><span class="line">        icl_rec(icl_type=icl_type, instruction=instruction, prompt=<span class="built_in">input</span>)</span><br><span class="line">        <span class="built_in">print</span>(output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># fire.Fire(icl_rec)</span></span><br><span class="line">    icl_rec(icl_type=<span class="string">&quot;llamacpp&quot;</span>)</span><br><span class="line">    <span class="comment"># icl_rec_batch(&quot;data/mind/test.json&quot;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多步骤<code>icl_multi_step_rec.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">personalized_generation</span>(<span class="params"></span></span><br><span class="line"><span class="params">        model: <span class="built_in">str</span> = <span class="string">&quot;qwen:72b-chat-v1.5-q5_K_M&quot;</span>,</span></span><br><span class="line"><span class="params">        temperature: <span class="built_in">float</span> = <span class="number">0.1</span>,</span></span><br><span class="line"><span class="params">        top_p: <span class="built_in">float</span> = <span class="number">0.95</span>,</span></span><br><span class="line"><span class="params">        ctx: <span class="built_in">int</span> = <span class="number">13000</span>,</span></span><br><span class="line"><span class="params">        message: <span class="built_in">list</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        is_stream: <span class="built_in">bool</span> = <span class="literal">False</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    利用Ollama框架将大模型封装成类似ChatGPT接口规范的API服务，基于提供的信息为你生产个性化的回答</span></span><br><span class="line"><span class="string">    :param model: ollama安装的大模型名</span></span><br><span class="line"><span class="string">    :param temperature: 温度</span></span><br><span class="line"><span class="string">    :param top_p: top_p</span></span><br><span class="line"><span class="string">    :param ctx: 生成token长度</span></span><br><span class="line"><span class="string">    :param message: 提供给大模型的对话信息</span></span><br><span class="line"><span class="string">    :param is_stream: 是否流式输出大模型的应答</span></span><br><span class="line"><span class="string">    :return: 基于prompt，利用大模型生成的结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        message = [&#123;&#125;]</span><br><span class="line">    url = <span class="string">&quot;http://localhost:11434/api/chat&quot;</span>  <span class="comment"># Ollama的api地址</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;model&quot;</span>: model,  <span class="comment"># Ollama安装的模型名</span></span><br><span class="line">        <span class="string">&quot;options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;temperature&quot;</span>: temperature,</span><br><span class="line">            <span class="string">&quot;top_p&quot;</span>: top_p,</span><br><span class="line">            <span class="string">&quot;num_ctx&quot;</span>: ctx,</span><br><span class="line">            <span class="string">&quot;num_gpu&quot;</span>: <span class="number">128</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: message,</span><br><span class="line">        <span class="string">&quot;stream&quot;</span>: is_stream</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> is_stream:</span><br><span class="line">        response = requests.post(url=url, json=data, stream=<span class="literal">True</span>)</span><br><span class="line">        res = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> response.iter_content(chunk_size=<span class="literal">None</span>, decode_unicode=<span class="literal">True</span>):</span><br><span class="line">            j = json.loads(chunk.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            res = res + j[<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">            <span class="built_in">print</span>(j[<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>], end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = requests.post(url=url, json=data, stream=<span class="literal">False</span>)</span><br><span class="line">        res = json.loads(response.content)[<span class="string">&quot;message&quot;</span>][<span class="string">&quot;content&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    instruction = (<span class="string">&quot;You are a recommendation system expert in the news field, providing personalized &quot;</span></span><br><span class="line">                   <span class="string">&quot;recommendations to users based on the background information provided.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    portrait_prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        The news I have browsed: </span></span><br><span class="line"><span class="string">        [&#x27;&#x27;Wheel Of Fortune&#x27; Guest Delivers Hilarious, Off The Rails Introduction&#x27;,&#x27;Hard Rock Hotel New Orleans collapse: Former site engineer weighs in&#x27;,&#x27;Felicity Huffman begins prison sentence for college admissions scam&#x27;,&#x27;Outer Banks storms unearth old shipwreck from &#x27;Graveyard of the Atlantic&#x27;&#x27;,&#x27;Tiffany&#x27;s is selling a holiday advent calendar for $112,000&#x27;,&#x27;This restored 1968 Winnebago is beyond adorable&#x27;,&#x27;Lori Loughlin Is &#x27;Absolutely Terrified&#x27; After Being Hit With New Charge&#x27;,&#x27;Bruce Willis brought Demi Moore to tears after reading her book&#x27;,&#x27;Celebrity kids then and now: See how they&#x27;ve grown&#x27;,&#x27;Felicity Huffman Smiles as She Begins Community Service Following Prison Release&#x27;,&#x27;Queen Elizabeth Finally Had Her Dream Photoshoot, Thanks to Royal Dresser Angela Kelly&#x27;,&#x27;Hundreds of thousands of people in California are downriver of a dam that &#x27;could fail&#x27;&#x27;,&#x27;Alexandria Ocasio-Cortez &#x27;sincerely&#x27; apologizes for blocking ex-Brooklyn politician on Twitter, settles federal lawsuit&#x27;,&#x27;The Rock&#x27;s Gnarly Palm Is a Testament to Life Without Lifting Gloves&#x27;]</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        What features are most important to me when selecting news (Summarize my preferences briefly)?</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    representable_prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    You will select the news (at most 5 news) that appeal to me the most from the list of news I have browsed, based on my personal preferences. The selected news will be presented in descending order of preference. (Format: no. a browsed news).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    rec_prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Candidate Set (candidate news): </span></span><br><span class="line"><span class="string">        1. &#x27;Browns apologize to Mason Rudolph, call Myles Garrett&#x27;s actions &#x27;unacceptable&#x27;&#x27;,</span></span><br><span class="line"><span class="string">        2. &#x27;I&#x27;ve been writing about tiny homes for a year and finally spent 2 nights in a 300-foot home to see what it&#x27;s all about   here&#x27;s how it went&#x27;,</span></span><br><span class="line"><span class="string">        3. &#x27;Opinion: Colin Kaepernick is about to get what he deserves: a chance&#x27;,</span></span><br><span class="line"><span class="string">        4. &#x27;The Kardashians Face Backlash Over &#x27;Insensitive&#x27; Family Food Fight in KUWTK Clip&#x27;,</span></span><br><span class="line"><span class="string">        5. &#x27;THEN AND NOW: What all your favorite &#x27;90s stars are doing today&#x27;,6. &#x27;Report: Police investigating woman&#x27;s death after Redskins&#x27; player Montae Nicholson took her to hospital&#x27;,</span></span><br><span class="line"><span class="string">        7. &#x27;U.S. Troops Will Die If They Remain in Syria, Bashar Al-Assad Warns&#x27;,</span></span><br><span class="line"><span class="string">        8. &#x27;3 Indiana judges suspended after a night of drinking turned into a White Castle brawl&#x27;,</span></span><br><span class="line"><span class="string">        9. &#x27;Cows swept away by Hurricane Dorian found alive   but how?&#x27;,</span></span><br><span class="line"><span class="string">        10. &#x27;Surviving Santa Clarita school shooting victims on road to recovery: Latest&#x27;,</span></span><br><span class="line"><span class="string">        11. &#x27;The Unlikely Star of My Family&#x27;s Thanksgiving Table&#x27;,</span></span><br><span class="line"><span class="string">        12. &#x27;Meghan Markle and Hillary Clinton Secretly Spent the Afternoon Together at Frogmore Cottage&#x27;,</span></span><br><span class="line"><span class="string">        13. &#x27;Former North Carolina State, NBA player Anthony Grundy dies in stabbing, police say&#x27;,</span></span><br><span class="line"><span class="string">        14. &#x27;85 Thanksgiving Recipes You Can Make Ahead&#x27;,</span></span><br><span class="line"><span class="string">        15. &#x27;Survivor Contestants Missy Byrd and Elizabeth Beisel Apologize For Their Actions&#x27;,</span></span><br><span class="line"><span class="string">        16. &#x27;Pete Davidson, Kaia Gerber Are Dating, Trying to Stay &#x27;Low Profile&#x27;&#x27;,</span></span><br><span class="line"><span class="string">        17. &#x27;There&#x27;s a place in the US where its been over 80 degrees since March&#x27;,</span></span><br><span class="line"><span class="string">        18. &#x27;Taylor Swift Rep Hits Back at Big Machine, Claims She&#x27;s Actually Owed $7.9 Million in Unpaid Royalties&#x27;,</span></span><br><span class="line"><span class="string">        19. &#x27;The most talked about movie moments of the 2010s&#x27;,</span></span><br><span class="line"><span class="string">        20. &#x27;Belichick mocks social media in comments on Garrett incident&#x27;,</span></span><br><span class="line"><span class="string">        21. &#x27;13 Reasons Why&#x27;s Christian Navarro Slams Disney for Casting &#x27;the White Guy&#x27; in The Little Mermaid&#x27;,</span></span><br><span class="line"><span class="string">        22. &#x27;66 Cool Tech Gifts Anyone Would Be Thrilled to Receive&#x27;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Can you recommend 3 news from the Candidate Set similar to the selected news I&#x27;ve browsed (Format: [no. a browsed news : &lt;- a candidate news &gt;])?</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    stream = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    step_1_message = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: instruction</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: portrait_prompt</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;========== step 1 start ================&quot;</span>)</span><br><span class="line"></span><br><span class="line">    step_1_output = personalized_generation(message=step_1_message, is_stream=stream)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stream:</span><br><span class="line">        <span class="built_in">print</span>(step_1_output)</span><br><span class="line"></span><br><span class="line">    step_2_message = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: instruction</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: portrait_prompt</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: step_1_output</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: representable_prompt</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;========== step 2 start ================&quot;</span>)</span><br><span class="line"></span><br><span class="line">    step_2_output = personalized_generation(message=step_2_message, is_stream=stream)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stream:</span><br><span class="line">        <span class="built_in">print</span>(step_2_output)</span><br><span class="line"></span><br><span class="line">    step_3_message = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: instruction</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: portrait_prompt</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: step_1_output</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: representable_prompt</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: step_2_output</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: rec_prompt</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;========== step 3 start ================&quot;</span>)</span><br><span class="line"></span><br><span class="line">    step_3_output = personalized_generation(message=step_3_message, is_stream=stream)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stream:</span><br><span class="line">        <span class="built_in">print</span>(step_3_output)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://isSeymour.github.io/butterflyblog">isSeymour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://isseymour.github.io/butterflyblog/2025/04/26/LLM4Rec_abc_4/">https://isseymour.github.io/butterflyblog/2025/04/26/LLM4Rec_abc_4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://isSeymour.github.io/butterflyblog" target="_blank">isSeymour</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/butterflyblog/tags/LLM/">LLM</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY1.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY1.jpg" alt="微信支付"/></a><div class="post-qr-code-desc">微信支付</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY2.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY2.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_3/" title="大模型推荐系统（3）微调范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/3/llm4rec-abc-3-Page.webp" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">大模型推荐系统（3）微调范式</div></div></a></div><div class="next-post pull-right"><a href="/butterflyblog/2025/04/27/LLM4Rec_abc_5/" title="大模型推荐系统 (应用)"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/5/llm4rec-abc-5-Page.webp" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">大模型推荐系统 (应用)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_2/" title="大模型推荐系统（2）预训练范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/2/llm4rec-abc-2-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（2）预训练范式</div></div></a></div><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_3/" title="大模型推荐系统（3）微调范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/3/llm4rec-abc-3-Page.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（3）微调范式</div></div></a></div><div><a href="/butterflyblog/2025/04/25/LLM4Rec_abc_1/" title="大模型推荐系统（1）生成范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-25</div><div class="title">大模型推荐系统（1）生成范式</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/T6.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">isSeymour</div><div class="author-info__description">志之所趋，无远弗届，穷山距海，不能限也。</div></div><div class="card-info-data site-data is-center"><a href="/butterflyblog/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/butterflyblog/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/butterflyblog/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/isSeymour/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://isSeymour.github.io/" target="_blank" title="学术主页"><i class="fa-regular fa-address-card" style="color: #000000;"></i></a><a class="social-icon" href="https://github.com/isSeymour/" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/79699613/" target="_blank" title="B站"><i class="fa-brands fa-bilibili" style="color: #000000;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_63205991/" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #000000;"></i></a><a class="social-icon" href="mailto:seymour0314@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">直接推荐范式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0%E6%8E%A8%E8%8D%90%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-text">1、上下文学习推荐基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%A1%88%E4%BE%8B"><span class="toc-text">2、案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-LLMRank-%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.1 LLMRank 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.2 多任务实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-NIR%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.3 NIR实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0%E6%8E%A8%E8%8D%90%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">3、上下文学习推荐代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-text">3.1 数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0%E6%8E%A8%E8%8D%90"><span class="toc-text">3.2 上下文学习推荐</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By isSeymour</div><div class="footer_custom_text">欢迎乘坐我的生活地铁！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/butterflyblog/js/utils.js"></script><script src="/butterflyblog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23liAZxomGv7Hapw8g',
      clientSecret: 'f7cafde192c4ada8bef4b76952c422d90575cf8b',
      repo: 'gitalk',
      owner: 'isSeymour',
      admin: ['isSeymour'],
      id: '02a87dc3e8b2bac460adeeb26c0665c2',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/butterflyblog/js/search/local-search.js"></script></div></div></body></html>