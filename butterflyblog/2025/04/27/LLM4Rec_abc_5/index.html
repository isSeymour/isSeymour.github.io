<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>大模型推荐系统 (应用) | isSeymour</title><meta name="author" content="isSeymour"><meta name="copyright" content="isSeymour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强 数据集来源：  MIND 新闻数据集对应论文MIND: A Large-scale Dataset for News Recommendation Amazon 电商数据集  注：大型文件包工具git-lfs、强化学习训练工具trl  大模型在电商推荐中的应用 1、冷启动 1.1 数据准备  由于涉及冷启动商品生成模拟的用户行为">
<meta property="og:type" content="article">
<meta property="og:title" content="大模型推荐系统 (应用)">
<meta property="og:url" content="https://isseymour.github.io/butterflyblog/2025/04/27/LLM4Rec_abc_5/index.html">
<meta property="og:site_name" content="isSeymour">
<meta property="og:description" content="阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强 数据集来源：  MIND 新闻数据集对应论文MIND: A Large-scale Dataset for News Recommendation Amazon 电商数据集  注：大型文件包工具git-lfs、强化学习训练工具trl  大模型在电商推荐中的应用 1、冷启动 1.1 数据准备  由于涉及冷启动商品生成模拟的用户行为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/5/llm4rec-abc-5-Page.webp">
<meta property="article:published_time" content="2025-04-27T08:00:00.000Z">
<meta property="article:modified_time" content="2025-04-27T08:00:00.000Z">
<meta property="article:author" content="isSeymour">
<meta property="article:tag" content="LLM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/5/llm4rec-abc-5-Page.webp"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/IC1011.ico"><link rel="canonical" href="https://isseymour.github.io/butterflyblog/2025/04/27/LLM4Rec_abc_5/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/butterflyblog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/butterflyblog/',
  algolia: undefined,
  localSearch: {"path":"/butterflyblog/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '大模型推荐系统 (应用)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-27 16:00:00'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/butterflyblog/code/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/T6.jpg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/butterflyblog/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/butterflyblog/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/butterflyblog/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> 总览</span></a></li><li><a class="site-page child" href="/butterflyblog/tags/"><i class="fa-fw fa-sharp fa-solid fa-hashtag"></i><span> 标签</span></a></li><li><a class="site-page child" href="/butterflyblog/categories/"><i class="fa-fw fa-sharp fa-solid fa-folder"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-list"></i><span> 功能</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/ctf/"><i class="fa-fw fa-solid fa-shield-halved"></i><span> CTF</span></a></li><li><a class="site-page child" href="/butterflyblog/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/butterflyblog/tools/"><i class="fa-fw fa-solid fa-screwdriver-wrench"></i><span> 下载</span></a></li><li><a class="site-page child" href="/butterflyblog/link/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-university"></i><span> 算法</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/algorithm/hot100/"><i class="fa-fw fa-solid fa-fire"></i><span> HOT100</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/labuladong/"><i class="fa-fw fa-solid fa-coffee"></i><span> labuladong</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/luogu/"><i class="fa-fw fa-solid fa-magnet"></i><span> 洛谷</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/template/"><i class="fa-fw fa-solid fa-code"></i><span> Template</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-plane"></i><span> 旅途</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/journey/english/"><i class="fa-fw fa-solid fa-globe"></i><span> 英语</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/RecSys/"><i class="fa-fw fa-solid fa-thumbs-up"></i><span> RecSys</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-regular fa-user"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/about/"><i class="fa-fw fa-regular fa-user"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/butterflyblog/message/"><i class="fa-fw fa-solid fa-message"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/butterflyblog/develop/"><i class="fa-fw fa-brands fa-windows"></i><span> 开发日志</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/5/llm4rec-abc-5-Page.webp')"><nav id="nav"><span id="blog-info"><a href="/butterflyblog/" title="isSeymour"><span class="site-name">isSeymour</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> 总览</span></a></li><li><a class="site-page child" href="/butterflyblog/tags/"><i class="fa-fw fa-sharp fa-solid fa-hashtag"></i><span> 标签</span></a></li><li><a class="site-page child" href="/butterflyblog/categories/"><i class="fa-fw fa-sharp fa-solid fa-folder"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-list"></i><span> 功能</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/ctf/"><i class="fa-fw fa-solid fa-shield-halved"></i><span> CTF</span></a></li><li><a class="site-page child" href="/butterflyblog/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/butterflyblog/tools/"><i class="fa-fw fa-solid fa-screwdriver-wrench"></i><span> 下载</span></a></li><li><a class="site-page child" href="/butterflyblog/link/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-university"></i><span> 算法</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/algorithm/hot100/"><i class="fa-fw fa-solid fa-fire"></i><span> HOT100</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/labuladong/"><i class="fa-fw fa-solid fa-coffee"></i><span> labuladong</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/luogu/"><i class="fa-fw fa-solid fa-magnet"></i><span> 洛谷</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/template/"><i class="fa-fw fa-solid fa-code"></i><span> Template</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-plane"></i><span> 旅途</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/journey/english/"><i class="fa-fw fa-solid fa-globe"></i><span> 英语</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/RecSys/"><i class="fa-fw fa-solid fa-thumbs-up"></i><span> RecSys</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-regular fa-user"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/about/"><i class="fa-fw fa-regular fa-user"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/butterflyblog/message/"><i class="fa-fw fa-solid fa-message"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/butterflyblog/develop/"><i class="fa-fw fa-brands fa-windows"></i><span> 开发日志</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">大模型推荐系统 (应用)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-27T08:00:00.000Z" title="发表于 2025-04-27 16:00:00">2025-04-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-27T08:00:00.000Z" title="更新于 2025-04-27 16:00:00">2025-04-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/butterflyblog/categories/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/">推荐系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>47分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="大模型推荐系统 (应用)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note danger no-icon flat"><p>阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强<br>
数据集来源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://msnews.github.io">MIND 新闻数据集</a>对应论文<a target="_blank" rel="noopener" href="https://msnews.github.io/assets/doc/ACL2020_MIND.pdf">MIND: A Large-scale Dataset for News Recommendation</a></li>
<li><a target="_blank" rel="noopener" href="https://cseweb.ucsd.edu/~jmcauley/datasets/amazon_v2/">Amazon 电商数据集</a></li>
</ul>
<p>注：大型文件包工具<a target="_blank" rel="noopener" href="https://git-lfs.com">git-lfs</a>、强化学习训练工具<a target="_blank" rel="noopener" href="https://github.com/huggingface/trl">trl</a></p>
</div>
<h1>大模型在电商推荐中的应用</h1>
<h2 id="1、冷启动">1、冷启动</h2>
<h3 id="1-1-数据准备">1.1 数据准备</h3>
<blockquote>
<p>由于涉及冷启动商品生成模拟的用户行为，因此需要确定哪些是冷启动商品。</p>
<ul>
<li>将用户行为数据按照时间排序，前 70%作为训练样本，后 30%作为测试样本。</li>
<li>只在测试数据中出现但不在训练数据中出现的商品就被认为是冷启动商品。</li>
</ul>
</blockquote>
<p>代码<code>cold_start/utils/utils.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">TRAIN_RATIO = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取相关数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">path</span>):</span><br><span class="line">    g = <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> g:</span><br><span class="line">        <span class="keyword">yield</span> json.loads(row)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将数据存为 DataFrame 格式，方便后续处理</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_df</span>(<span class="params">path</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    df_ = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> parse(path):</span><br><span class="line">        df_[i] = d</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> pd.DataFrame.from_dict(df_, orient=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cold_start_items</span>(<span class="params">path_review: <span class="built_in">str</span> = <span class="string">&quot;../data/amazon_review/beauty/All_Beauty_5.json&quot;</span></span>) -&gt; <span class="built_in">set</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将用户行为数据按照时间升序排列，取后面的30%的数据，该数据中的item在前面的70%中不存在，就认为是冷启动数据</span></span><br><span class="line"><span class="string">    :param path_review: 用户行为数据目录</span></span><br><span class="line"><span class="string">    :return: 冷启动物品</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    df_view = get_df(path_review)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对unixReviewTime升序排序</span></span><br><span class="line">    df_view.sort_values(<span class="string">&#x27;unixReviewTime&#x27;</span>, ascending=<span class="literal">True</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    df_view = df_view.reset_index(drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    rows_num = df_view.shape[<span class="number">0</span>]</span><br><span class="line">    train_num = <span class="built_in">int</span>(rows_num * <span class="number">0.7</span>)</span><br><span class="line"></span><br><span class="line">    train_df = df_view.head(train_num)</span><br><span class="line">    test_df = df_view.iloc[train_num:]</span><br><span class="line"></span><br><span class="line">    train_items = <span class="built_in">set</span>(train_df[<span class="string">&#x27;asin&#x27;</span>].unique())  <span class="comment"># 71个</span></span><br><span class="line">    test_items = <span class="built_in">set</span>(test_df[<span class="string">&#x27;asin&#x27;</span>].unique())  <span class="comment"># 44个</span></span><br><span class="line"></span><br><span class="line">    cold_start_items = test_items.difference(train_items)  <span class="comment"># 14个</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cold_start_items</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_history</span>(<span class="params">path_review: <span class="built_in">str</span> = <span class="string">&quot;../data/amazon_review/beauty/All_Beauty_5.json&quot;</span>,</span></span><br><span class="line"><span class="params">                     data_type: <span class="built_in">str</span> = <span class="string">&quot;train&quot;</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将用户行为数据按照时间升序排列，取用户行为字典</span></span><br><span class="line"><span class="string">    :param data_type: 是取前面70%的训练数据，还是后面30%的测试数据</span></span><br><span class="line"><span class="string">    :param path_review: 用户行为数据目录</span></span><br><span class="line"><span class="string">    :return: 用户行为历史</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df_view = get_df(path_review)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对unixReviewTime升序排序</span></span><br><span class="line">    df_view.sort_values(<span class="string">&#x27;unixReviewTime&#x27;</span>, ascending=<span class="literal">True</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    df_view = df_view.reset_index(drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    rows_num = df_view.shape[<span class="number">0</span>]</span><br><span class="line">    train_num = <span class="built_in">int</span>(rows_num * TRAIN_RATIO)</span><br><span class="line">    df = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> data_type == <span class="string">&quot;train&quot;</span>:</span><br><span class="line">        df = df_view.head(train_num)</span><br><span class="line">    <span class="keyword">if</span> data_type == <span class="string">&quot;test&quot;</span>:</span><br><span class="line">        df = df_view.iloc[train_num:]</span><br><span class="line"></span><br><span class="line">    grouped = df.groupby(<span class="string">&#x27;reviewerID&#x27;</span>)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; grouped.get_group(&#x27;A105A034ZG9EHO&#x27;)</span></span><br><span class="line"><span class="string">      overall  verified  reviewTime      reviewerID        asin              style reviewerName reviewText     summary  unixReviewTime vote image</span></span><br><span class="line"><span class="string">1246      5.0      True  07 6, 2014  A105A034ZG9EHO  B0009RF9DW  &#123;&#x27;Size:&#x27;: &#x27; 180&#x27;&#125;      K. Mras        yum  Five Stars      1404604800  NaN   NaN</span></span><br><span class="line"><span class="string">1247      5.0      True  07 6, 2014  A105A034ZG9EHO  B000FI4S1E                NaN      K. Mras        yum  Five Stars      1404604800  NaN   NaN</span></span><br><span class="line"><span class="string">1250      5.0      True  07 6, 2014  A105A034ZG9EHO  B0012Y0ZG2  &#123;&#x27;Size:&#x27;: &#x27; 180&#x27;&#125;      K. Mras        yum  Five Stars      1404604800  NaN   NaN</span></span><br><span class="line"><span class="string">1252      5.0      True  07 6, 2014  A105A034ZG9EHO  B000URXP6E  &#123;&#x27;Size:&#x27;: &#x27; 180&#x27;&#125;      K. Mras        yum  Five Stars      1404604800  NaN   NaN</span></span><br><span class="line"><span class="string">1253      5.0      True  07 6, 2014  A105A034ZG9EHO  B0012Y0ZG2  &#123;&#x27;Size:&#x27;: &#x27; 180&#x27;&#125;      K. Mras        yum  Five Stars      1404604800  NaN   NaN</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    user_history_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> name, group <span class="keyword">in</span> grouped:</span><br><span class="line">        reviewerID = name</span><br><span class="line">        asin = group[<span class="string">&#x27;asin&#x27;</span>]</span><br><span class="line">        user_history_dict[reviewerID] = <span class="built_in">set</span>(asin)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> user_history_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_metadata_dict</span>(<span class="params">path: <span class="built_in">str</span> = <span class="string">&#x27;../data/amazon_review/beauty/meta_All_Beauty.json&#x27;</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    读取商品metadata数据，将商品的核心进行取出来，方便后面大模型使用</span></span><br><span class="line"><span class="string">    :param path: 商品metadata数据目录</span></span><br><span class="line"><span class="string">    :return: 商品信息字典</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    item_dict = &#123;&#125;  <span class="comment"># meta_All_Beauty.json中获取每个item对应的信息</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;&quot;category&quot;: [], &quot;tech1&quot;: &quot;&quot;, &quot;description&quot;: [&quot;Start Up combines citrus essential oils with gentle Alpha Hydroxy Acids to cleanse and refresh your face. The 5% AHA level is gentle enough for all skin types.&quot;, &quot;&quot;, &quot;&quot;], </span></span><br><span class="line"><span class="string">    &quot;fit&quot;: &quot;&quot;, &quot;title&quot;: &quot;Kiss My Face Exfoliating Face Wash Start Up, 4 Fluid Ounce&quot;, </span></span><br><span class="line"><span class="string">    &quot;also_buy&quot;: [&quot;B000Z96JDI&quot;, &quot;B00006IGL8&quot;, &quot;B007C5X34G&quot;, &quot;B00006IGLF&quot;, &quot;B00213WCNC&quot;, &quot;B00D1W1QXE&quot;, &quot;B001FB5HZG&quot;, &quot;B000FQ86RI&quot;, &quot;B0012BSKBM&quot;, &quot;B0085EVLRO&quot;, &quot;B00A2EXVQE&quot;], </span></span><br><span class="line"><span class="string">    &quot;tech2&quot;: &quot;&quot;, &quot;brand&quot;: &quot;Kiss My Face&quot;, &quot;feature&quot;: [], &quot;rank&quot;: [], </span></span><br><span class="line"><span class="string">    &quot;also_view&quot;: [&quot;B000Z96JDI&quot;, &quot;B001FB5HZG&quot;, &quot;B00213WCNC&quot;, &quot;B00BBFOVO4&quot;, &quot;B0085EVLRO&quot;], </span></span><br><span class="line"><span class="string">    &quot;details&quot;: &#123;&quot;\n    Product Dimensions: \n    &quot;: &quot;2.5 x 1.6 x 7 inches ; 4 ounces&quot;, &quot;Shipping Weight:&quot;: &quot;4 ounces&quot;, &quot;ASIN: &quot;: &quot;B00006IGL2&quot;, &quot;UPC:&quot;: &quot;890795851488 701320351987 601669038184 793379218755 028367831938 787734768894 756769626417&quot;, &quot;Item model number:&quot;: &quot;1200040&quot;&#125;,</span></span><br><span class="line"><span class="string">     &quot;main_cat&quot;: &quot;All Beauty&quot;, &quot;similar_item&quot;: &quot;&quot;, &quot;date&quot;: &quot;&quot;, &quot;price&quot;: &quot;&quot;, </span></span><br><span class="line"><span class="string">     &quot;asin&quot;: &quot;B00006IGL2&quot;, &quot;imageURL&quot;: [&quot;https://images-na.ssl-images-amazon.com/images/I/41i07fBAznL._SS40_.jpg&quot;, </span></span><br><span class="line"><span class="string">     &quot;https://images-na.ssl-images-amazon.com/images/I/31W8DZRVD1L._SS40_.jpg&quot;], &quot;imageURLHighRes&quot;: [&quot;https://images-na.ssl-images-amazon.com/images/I/41i07fBAznL.jpg&quot;, &quot;https://images-na.ssl-images-amazon.com/images/I/31W8DZRVD1L.jpg&quot;]&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        reader = csv.reader(file, delimiter=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">            j = json.loads(row[<span class="number">0</span>])</span><br><span class="line">            item_id = j[<span class="string">&#x27;asin&#x27;</span>]</span><br><span class="line">            title = j[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">            brand = j[<span class="string">&#x27;brand&#x27;</span>]</span><br><span class="line">            description = j[<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">            price = j[<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> price != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> <span class="string">&#x27;$&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> price <span class="keyword">and</span> <span class="built_in">len</span>(price) &gt; <span class="number">10</span>:  <span class="comment"># 处理一些异常数据情况</span></span><br><span class="line">                price = <span class="string">&quot;&quot;</span></span><br><span class="line">            item_info = &#123;</span><br><span class="line">                <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">                <span class="string">&quot;brand&quot;</span>: brand,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">                <span class="string">&quot;price&quot;</span>: price</span><br><span class="line">            &#125;</span><br><span class="line">            item_dict[item_id] = item_info</span><br><span class="line">    <span class="keyword">return</span> item_dict</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将测试数据生成为微调样本。<br>
代码<code>cold_start/data-process/generate_finetune_data.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;../utils&#x27;</span>)</span><br><span class="line">utils = importlib.import_module(<span class="string">&#x27;utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line">TRAIN_RATIO = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line">instruction = (<span class="string">&quot;You are a product expert who predicts which products &quot;</span></span><br><span class="line">               <span class="string">&quot;users prefer based on your professional knowledge.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">formatting_input</span>(<span class="params">history, candidate</span>):</span><br><span class="line">    <span class="built_in">input</span> = <span class="string">f&quot;&quot;&quot;The user purchased the following beauty products(in JSON format): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;history&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Predict if the user will prefer to purchase the following beauty candidate list(in JSON format):</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;candidate&#125;</span> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can choice none, one or more, your output must be JSON format, you just need output item_id, the following is an</span></span><br><span class="line"><span class="string">output example, A and B is product item_id.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&quot;A&quot;, &quot;B&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your output must in the candidate list, don&#x27;t explain.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">按照如下格式构建训练数据集：</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;instruction&quot;: &quot;You are a product expert who predicts which products users prefer based on your professional knowledge.&quot;,</span></span><br><span class="line"><span class="string">        &quot;input&quot;: &quot;The user purchased the following beauty products(in JSON format): </span></span><br><span class="line"><span class="string">            [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    &quot;title&quot;: &quot;Fruits &amp;amp; Passion Blue Refreshing Shower Gel - 6.7 fl. oz.&quot;,</span></span><br><span class="line"><span class="string">                    &quot;brand&quot;: &quot;Fruits &amp; Passion&quot;,</span></span><br><span class="line"><span class="string">                    &quot;price&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">                    &quot;item_id&quot;: &quot;B000FI4S1E&quot;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    &quot;title&quot;: &quot;Yardley By Yardley Of London Unisexs Lay It On Thick Hand &amp;amp; Foot Cream 5.3 Oz&quot;,</span></span><br><span class="line"><span class="string">                    &quot;brand&quot;: &quot;Yardley&quot;,</span></span><br><span class="line"><span class="string">                    &quot;price&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">                    &quot;item_id&quot;: &quot;B0009RF9DW&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Predict if the user will prefer to purchase the following beauty candidate list(in JSON format):</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">           [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    &quot;title&quot;: &quot;Helen of Troy 1579 Tangle Free Hot Air Brush, White, 3/4 Inch Barrel&quot;,</span></span><br><span class="line"><span class="string">                    &quot;brand&quot;: &quot;Helen Of Troy&quot;,</span></span><br><span class="line"><span class="string">                    &quot;price&quot;: &quot;$28.70&quot;,</span></span><br><span class="line"><span class="string">                    &quot;item_id&quot;: &quot;B000WYJTZG&quot;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    &quot;title&quot;: &quot;Dolce &amp;amp; Gabbana Compact Parfum, 0.05 Ounce&quot;,</span></span><br><span class="line"><span class="string">                    &quot;brand&quot;: &quot;Dolce &amp; Gabbana&quot;,</span></span><br><span class="line"><span class="string">                    &quot;price&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">                    &quot;item_id&quot;: &quot;B019V2KYZS&quot;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                ...</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &quot;output&quot;: &#x27;[&quot;B0012Y0ZG2&quot;,&quot;B000URXP6E&quot;]&#x27;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_data</span>(<span class="params">output_path: <span class="built_in">str</span> = <span class="string">&#x27;../data/train.json&#x27;</span></span>):</span><br><span class="line">    item_dict = utils.get_metadata_dict()</span><br><span class="line">    train_user_dict = utils.get_user_history(data_type=<span class="string">&quot;train&quot;</span>)</span><br><span class="line">    cold_start_items = utils.get_cold_start_items()</span><br><span class="line">    action_items = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">for</span> _, items <span class="keyword">in</span> train_user_dict.items():</span><br><span class="line">        action_items = action_items.union(items)</span><br><span class="line">    unique_items = action_items.difference(cold_start_items)  <span class="comment"># 这里是测试集中不在冷启动中的item集合</span></span><br><span class="line"></span><br><span class="line">    C = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> unique_items:</span><br><span class="line">        info = item_dict[item]</span><br><span class="line">        info[<span class="string">&#x27;item_id&#x27;</span>] = item</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;description&#x27;</span> <span class="keyword">in</span> info:</span><br><span class="line">            <span class="keyword">del</span> info[<span class="string">&#x27;description&#x27;</span>]  <span class="comment"># description 字段太长了，消耗的token太多，剔除掉</span></span><br><span class="line">        C.append(info)</span><br><span class="line">    candidate = json.dumps(C, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)  <span class="comment"># 这是所有训练集中不在冷启动id的item</span></span><br><span class="line"></span><br><span class="line">    data_list = []</span><br><span class="line">    <span class="keyword">for</span> user, history <span class="keyword">in</span> train_user_dict.items():</span><br><span class="line">        H = []</span><br><span class="line">        history = [item <span class="keyword">for</span> item <span class="keyword">in</span> history <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> cold_start_items]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(history) &gt; <span class="number">1</span>:  <span class="comment"># 该用户至少还剩余2个action items</span></span><br><span class="line">            train_num = <span class="built_in">int</span>(<span class="built_in">len</span>(history) * TRAIN_RATIO)</span><br><span class="line">            train_history = history[:train_num]</span><br><span class="line">            test_history = history[train_num:]</span><br><span class="line">            <span class="keyword">for</span> h <span class="keyword">in</span> train_history:</span><br><span class="line">                info = item_dict[h]</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;description&#x27;</span> <span class="keyword">in</span> info:</span><br><span class="line">                    <span class="keyword">del</span> info[<span class="string">&#x27;description&#x27;</span>]  <span class="comment"># description 字段太长了，消耗的token太多，剔除掉</span></span><br><span class="line">                H.append(info)</span><br><span class="line">            HH = json.dumps(H, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            output = json.dumps(test_history, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            <span class="built_in">input</span> = formatting_input(HH, candidate)</span><br><span class="line">            d = &#123;</span><br><span class="line">                <span class="string">&quot;instruction&quot;</span>: instruction,</span><br><span class="line">                <span class="string">&quot;input&quot;</span>: <span class="built_in">input</span>,</span><br><span class="line">                <span class="string">&quot;output&quot;</span>: output</span><br><span class="line">            &#125;</span><br><span class="line">            data_list.append(d)</span><br><span class="line"></span><br><span class="line">    train_res = json.dumps(data_list, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file_:  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line">        file_.write(train_res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    generate_data()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-2-生成冷启动商品的行为样本">1.2 生成冷启动商品的行为样本</h3>
<p>如何为冷启动商品生成模拟的用户行为呢？</p>
<ol>
<li>在训练集中随机找20%的用户</li>
<li>在冷启动商品中随机找两个商品</li>
<li>让大模型基于用户过往行为，选择一个用户可能喜欢的商品</li>
</ol>
<p>代码<code>cold_start/data-process/generate_samples.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;../utils&#x27;</span>)</span><br><span class="line">utils = importlib.import_module(<span class="string">&#x27;utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv_vault <span class="keyword">import</span> load_dotenv  <span class="comment"># pip install --upgrade python-dotenv-vault</span></span><br><span class="line"></span><br><span class="line">load_dotenv()  <span class="comment"># https://vault.dotenv.org/ui/ui1</span></span><br><span class="line"></span><br><span class="line">MOONSHOT_API_KEY = os.getenv(<span class="string">&quot;MOONSHOT_API_KEY&quot;</span>)</span><br><span class="line"></span><br><span class="line">instruction = (<span class="string">&quot;You are a product expert who predicts which of the two products &quot;</span></span><br><span class="line">               <span class="string">&quot;users prefer based on your professional knowledge.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">formatting_prompt</span>(<span class="params">History, item_a, item_b</span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;The user purchased the following beauty products in JSON format: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;History&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Predict if the user will prefer to purchase product A or B in the next.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A is:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;item_a&#125;</span> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">B is:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;item_b&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your answer must be A or B, don&#x27;t explain.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> prompt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_cold_start_samples</span>(<span class="params">store_path: <span class="built_in">str</span> = <span class="string">&#x27;../data/cold_start_action_sample.json&#x27;</span></span>):</span><br><span class="line">    item_dict = utils.get_metadata_dict()</span><br><span class="line">    user_history = utils.get_user_history(data_type=<span class="string">&quot;train&quot;</span>)</span><br><span class="line">    cold_start_items = utils.get_cold_start_items()</span><br><span class="line"></span><br><span class="line">    generated_samples = []</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> user, history <span class="keyword">in</span> user_history.items():</span><br><span class="line">        rd = random.random()</span><br><span class="line">        <span class="keyword">if</span> rd &lt; <span class="number">0.2</span>:  <span class="comment"># 随机选择20%的用户</span></span><br><span class="line">            random_2_elements = random.sample(<span class="built_in">list</span>(cold_start_items), <span class="number">2</span>)</span><br><span class="line">            H = []</span><br><span class="line">            <span class="keyword">for</span> h <span class="keyword">in</span> history:</span><br><span class="line">                info = item_dict[h]</span><br><span class="line">                H.append(info)</span><br><span class="line">            HH = json.dumps(H, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            A = item_dict[random_2_elements[<span class="number">0</span>]]</span><br><span class="line">            B = item_dict[random_2_elements[<span class="number">1</span>]]</span><br><span class="line">            AA = json.dumps(A, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            BB = json.dumps(B, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            prom = formatting_prompt(HH, AA, BB)</span><br><span class="line"></span><br><span class="line">            client = OpenAI(</span><br><span class="line">                api_key=MOONSHOT_API_KEY,</span><br><span class="line">                base_url=<span class="string">&quot;https://api.moonshot.cn/v1&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">            llm_response = client.chat.completions.create(</span><br><span class="line">                model=<span class="string">&quot;moonshot-v1-32k&quot;</span>,  <span class="comment"># moonshot-v1-8k 、moonshot-v1-32k、moonshot-v1-128k</span></span><br><span class="line">                messages=[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: instruction,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prom&#125;,</span><br><span class="line">                ],</span><br><span class="line">                temperature=<span class="number">0.1</span>,</span><br><span class="line">                stream=<span class="literal">False</span>,</span><br><span class="line">            )</span><br><span class="line">            choice = llm_response.choices[<span class="number">0</span>].message.content.strip()</span><br><span class="line">            sample = &#123;&#125;</span><br><span class="line">            <span class="keyword">if</span> choice == <span class="string">&quot;A&quot;</span>:</span><br><span class="line">                sample = &#123;</span><br><span class="line">                    <span class="string">&quot;user&quot;</span>: user,</span><br><span class="line">                    <span class="string">&quot;item&quot;</span>: random_2_elements[<span class="number">0</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                generated_samples.append(sample)</span><br><span class="line">            <span class="keyword">if</span> choice == <span class="string">&quot;B&quot;</span>:</span><br><span class="line">                sample = &#123;</span><br><span class="line">                    <span class="string">&quot;user&quot;</span>: user,</span><br><span class="line">                    <span class="string">&quot;item&quot;</span>: random_2_elements[<span class="number">1</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-------------- &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot; -----------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(json.dumps(sample, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">            generated_samples.append(sample)</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">0</span>:</span><br><span class="line">                time.sleep(<span class="number">1</span>)  <span class="comment"># 避免moonshot认为调用太频繁不合法</span></span><br><span class="line"></span><br><span class="line">    res = json.dumps(generated_samples, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(store_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file:  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line">        file.write(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    generate_cold_start_samples()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一旦为冷启动商品生成了模拟行为，就可以加入真实用户行为数据中。<br>
冷启动商品慢慢变热，就可以采用传统的推荐算法模型了。</p>
<h3 id="1-3-上下文学习能力">1.3 上下文学习能力</h3>
<p>冷启动召回：将用户在测试集中的行为作为用户的兴趣历史，然后将所有冷启动商品作为候选集，让大模型筛选出一些用户可能感兴趣的。</p>
<p>代码<code>cold_start/item_cold_start_rec.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> dotenv_vault <span class="keyword">import</span> load_dotenv  <span class="comment"># pip install --upgrade python-dotenv-vault</span></span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModelForCausalLM</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.utils <span class="keyword">import</span> get_metadata_dict, get_user_history, get_cold_start_items</span><br><span class="line"></span><br><span class="line">load_dotenv()  <span class="comment"># https://vault.dotenv.org/ui/ui1</span></span><br><span class="line"></span><br><span class="line">MOONSHOT_API_KEY = os.getenv(<span class="string">&quot;MOONSHOT_API_KEY&quot;</span>)</span><br><span class="line"></span><br><span class="line">instruction = (<span class="string">&quot;You are a product expert who predicts which products &quot;</span></span><br><span class="line">               <span class="string">&quot;users prefer based on your professional knowledge.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">formatting_prompt</span>(<span class="params">history, candidate</span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;The user purchased the following beauty products(in JSON format): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;history&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Predict if the user will prefer to purchase the following beauty candidate list(in JSON format):</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;candidate&#125;</span> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can choice none, one or more, your output must be JSON format, you just need output item_id, the following is an</span></span><br><span class="line"><span class="string">output example, A and B is product item_id.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&quot;A&quot;, &quot;B&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your output must in the candidate list, don&#x27;t explain.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> prompt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_api_cold_start_rec</span>(<span class="params">store_path: <span class="built_in">str</span> = <span class="string">&#x27;data/llm_api_rec.json&#x27;</span></span>):</span><br><span class="line">    item_dict = get_metadata_dict()</span><br><span class="line">    train_user_dict = get_user_history(data_type=<span class="string">&quot;train&quot;</span>)</span><br><span class="line">    test_user_dict = get_user_history(data_type=<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    common_users = <span class="built_in">set</span>(train_user_dict.keys()).intersection(<span class="built_in">set</span>(test_user_dict.keys()))</span><br><span class="line">    cold_start_items = get_cold_start_items()</span><br><span class="line"></span><br><span class="line">    generated_rec = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;total user number = &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(common_users)))</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> common_users:</span><br><span class="line">        H = []</span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> train_user_dict[user]:</span><br><span class="line">            info = item_dict[h]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;description&#x27;</span> <span class="keyword">in</span> info:</span><br><span class="line">                <span class="keyword">del</span> info[<span class="string">&#x27;description&#x27;</span>]  <span class="comment"># description 字段太长了，消耗的token太多，剔除掉</span></span><br><span class="line">            H.append(info)</span><br><span class="line">        history = json.dumps(H, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        C = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> cold_start_items:</span><br><span class="line">            info = item_dict[item]</span><br><span class="line">            info[<span class="string">&#x27;item_id&#x27;</span>] = item</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;description&#x27;</span> <span class="keyword">in</span> info:</span><br><span class="line">                <span class="keyword">del</span> info[<span class="string">&#x27;description&#x27;</span>]  <span class="comment"># description 字段太长了，消耗的token太多，剔除掉</span></span><br><span class="line">            C.append(info)</span><br><span class="line">        candidate = json.dumps(C, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        prom = formatting_prompt(history, candidate)</span><br><span class="line">        client = OpenAI(</span><br><span class="line">            api_key=MOONSHOT_API_KEY,</span><br><span class="line">            base_url=<span class="string">&quot;https://api.moonshot.cn/v1&quot;</span>,</span><br><span class="line">        )</span><br><span class="line">        llm_response = client.chat.completions.create(</span><br><span class="line">            model=<span class="string">&quot;moonshot-v1-32k&quot;</span>,  <span class="comment"># moonshot-v1-8k 、moonshot-v1-32k、moonshot-v1-128k</span></span><br><span class="line">            messages=[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: instruction,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prom&#125;,</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.1</span>,</span><br><span class="line">            stream=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        content = llm_response.choices[<span class="number">0</span>].message.content.strip()</span><br><span class="line">        rec = &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: user,</span><br><span class="line">            <span class="string">&quot;rec&quot;</span>: content</span><br><span class="line">        &#125;</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-------------- &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot; -----------------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(rec, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">        generated_rec.append(rec)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">0</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>)  <span class="comment"># 避免moonshot认为调用太频繁不合法</span></span><br><span class="line"></span><br><span class="line">    res = json.dumps(generated_rec, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(store_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file:  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line">        file.write(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openllm_cold_start_rec</span>(<span class="params">model_path: <span class="built_in">str</span> = <span class="string">&#x27;/Users/liuqiang/Desktop/code/llm/models/Qwen1.5-4B&#x27;</span>,</span></span><br><span class="line"><span class="params">                           store_path: <span class="built_in">str</span> = <span class="string">&#x27;data/openllm_rec.json&#x27;</span></span>):</span><br><span class="line">    item_dict = get_metadata_dict()</span><br><span class="line">    train_user_dict = get_user_history(data_type=<span class="string">&quot;train&quot;</span>)</span><br><span class="line">    test_user_dict = get_user_history(data_type=<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    common_users = <span class="built_in">set</span>(train_user_dict.keys()).intersection(<span class="built_in">set</span>(test_user_dict.keys()))</span><br><span class="line">    cold_start_items = get_cold_start_items()</span><br><span class="line"></span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        model_path,</span><br><span class="line">        device_map=<span class="string">&quot;auto&quot;</span>,</span><br><span class="line">        torch_dtype=torch.float16,</span><br><span class="line">    )</span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">    tokenizer.padding_side = <span class="string">&#x27;right&#x27;</span></span><br><span class="line"></span><br><span class="line">    generated_rec = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;total user number = &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(common_users)))</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> common_users:</span><br><span class="line">        H = []</span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> train_user_dict[user]:</span><br><span class="line">            info = item_dict[h]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;description&#x27;</span> <span class="keyword">in</span> info:</span><br><span class="line">                <span class="keyword">del</span> info[<span class="string">&#x27;description&#x27;</span>]  <span class="comment"># description 字段太长了，消耗的token太多，剔除掉</span></span><br><span class="line">            H.append(info)</span><br><span class="line">        history = json.dumps(H, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        C = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> cold_start_items:</span><br><span class="line">            info = item_dict[item]</span><br><span class="line">            info[<span class="string">&#x27;item_id&#x27;</span>] = item</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;description&#x27;</span> <span class="keyword">in</span> info:</span><br><span class="line">                <span class="keyword">del</span> info[<span class="string">&#x27;description&#x27;</span>]  <span class="comment"># description 字段太长了，消耗的token太多，剔除掉</span></span><br><span class="line">            C.append(info)</span><br><span class="line">        candidate = json.dumps(C, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">input</span> = formatting_prompt(history, candidate)</span><br><span class="line"></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;### Instruction:</span></span><br><span class="line"><span class="string">                    <span class="subst">&#123;instruction&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    ### Input:</span></span><br><span class="line"><span class="string">                    <span class="subst">&#123;<span class="built_in">input</span>&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    ### Response:</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        input_ids = tokenizer(prompt, return_tensors=<span class="string">&quot;pt&quot;</span>, truncation=<span class="literal">True</span>).input_ids</span><br><span class="line">        outputs = model.generate(input_ids=input_ids.to(<span class="string">&#x27;mps&#x27;</span>),</span><br><span class="line">                                 max_new_tokens=<span class="number">1500</span>, pad_token_id=tokenizer.eos_token_id)</span><br><span class="line">        predict_output = tokenizer.batch_decode(outputs, skip_special_tokens=<span class="literal">True</span>)[<span class="number">0</span>][<span class="built_in">len</span>(prompt):]</span><br><span class="line"></span><br><span class="line">        rec = &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: user,</span><br><span class="line">            <span class="string">&quot;rec&quot;</span>: predict_output</span><br><span class="line">        &#125;</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-------------- &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot; -----------------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(rec, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">        generated_rec.append(rec)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">0</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>)  <span class="comment"># 避免moonshot认为调用太频繁不合法</span></span><br><span class="line"></span><br><span class="line">    res = json.dumps(generated_rec, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(store_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file:  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line">        file.write(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    llm_api_cold_start_rec()</span><br><span class="line">    openllm_cold_start_rec(model_path=<span class="string">&#x27;./models&#x27;</span>, store_path=<span class="string">&#x27;data/openllm_finetune_rec.json&#x27;</span>)</span><br><span class="line">    openllm_cold_start_rec()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-4-模型微调">1.4 模型微调</h3>
<p>代码<code>cold_start/model_finetune.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> fire</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> (</span><br><span class="line">    LoraConfig,</span><br><span class="line">    get_peft_model,</span><br><span class="line">    prepare_model_for_int8_training,</span><br><span class="line">    set_peft_model_state_dict, PeftModel,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForCausalLM, AutoTokenizer, Trainer, DataCollatorForSeq2Seq, TrainingArguments</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.prompter <span class="keyword">import</span> Prompter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="comment"># model/data params</span></span></span><br><span class="line"><span class="params">        base_model: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,  <span class="comment"># the only required argument</span></span></span><br><span class="line"><span class="params">        data_path: <span class="built_in">str</span> = <span class="string">&quot;./data/train.json&quot;</span>,</span></span><br><span class="line"><span class="params">        output_dir: <span class="built_in">str</span> = <span class="string">&quot;./models&quot;</span>,</span></span><br><span class="line"><span class="params">        <span class="comment"># training hyperparams</span></span></span><br><span class="line"><span class="params">        batch_size: <span class="built_in">int</span> = <span class="number">128</span>,</span></span><br><span class="line"><span class="params">        micro_batch_size: <span class="built_in">int</span> = <span class="number">4</span>,</span></span><br><span class="line"><span class="params">        num_epochs: <span class="built_in">int</span> = <span class="number">3</span>,</span></span><br><span class="line"><span class="params">        learning_rate: <span class="built_in">float</span> = <span class="number">3e-4</span>,</span></span><br><span class="line"><span class="params">        cutoff_len: <span class="built_in">int</span> = <span class="number">256</span>,</span></span><br><span class="line"><span class="params">        val_set_size: <span class="built_in">int</span> = <span class="number">2000</span>,</span></span><br><span class="line"><span class="params">        <span class="comment"># lora hyperparams</span></span></span><br><span class="line"><span class="params">        lora_r: <span class="built_in">int</span> = <span class="number">8</span>,</span></span><br><span class="line"><span class="params">        lora_alpha: <span class="built_in">int</span> = <span class="number">16</span>,</span></span><br><span class="line"><span class="params">        lora_dropout: <span class="built_in">float</span> = <span class="number">0.05</span>,</span></span><br><span class="line"><span class="params">        lora_target_modules: <span class="type">List</span>[<span class="built_in">str</span>] = [</span></span><br><span class="line"><span class="params">            <span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;o_proj&quot;</span>, <span class="string">&quot;k_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>, <span class="string">&quot;gate_proj&quot;</span>, <span class="string">&quot;up_proj&quot;</span>, <span class="string">&quot;down_proj&quot;</span></span></span><br><span class="line"><span class="params">        ],</span></span><br><span class="line"><span class="params">        <span class="comment"># llm hyperparams</span></span></span><br><span class="line"><span class="params">        train_on_inputs: <span class="built_in">bool</span> = <span class="literal">True</span>,  <span class="comment"># if False, masks out inputs in loss</span></span></span><br><span class="line"><span class="params">        add_eos_token: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        group_by_length: <span class="built_in">bool</span> = <span class="literal">False</span>,  <span class="comment"># faster, but produces an odd training loss curve</span></span></span><br><span class="line"><span class="params">        <span class="comment"># wandb params</span></span></span><br><span class="line"><span class="params">        wandb_project: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        wandb_run_name: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        wandb_watch: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,  <span class="comment"># options: false | gradients | all</span></span></span><br><span class="line"><span class="params">        wandb_log_model: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,  <span class="comment"># options: false | true</span></span></span><br><span class="line"><span class="params">        resume_from_checkpoint: <span class="built_in">str</span> = <span class="literal">None</span>,  <span class="comment"># either training checkpoint or final adapter</span></span></span><br><span class="line"><span class="params">        prompt_template_name: <span class="built_in">str</span> = <span class="string">&quot;alpaca&quot;</span>,  <span class="comment"># The prompt template to use, will default to alpaca.</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">assert</span> (</span><br><span class="line">        base_model</span><br><span class="line">    ), <span class="string">&quot;Please specify a --base_model, e.g. --base_model=&#x27;huggyllama/llama-7b&#x27;&quot;</span></span><br><span class="line">    gradient_accumulation_steps = batch_size // micro_batch_size</span><br><span class="line"></span><br><span class="line">    prompter = Prompter(prompt_template_name)</span><br><span class="line"></span><br><span class="line">    device_map = <span class="string">&quot;auto&quot;</span></span><br><span class="line">    world_size = <span class="built_in">int</span>(os.environ.get(<span class="string">&quot;WORLD_SIZE&quot;</span>, <span class="number">1</span>))</span><br><span class="line">    ddp = world_size != <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> ddp:</span><br><span class="line">        device_map = &#123;<span class="string">&quot;&quot;</span>: <span class="built_in">int</span>(os.environ.get(<span class="string">&quot;LOCAL_RANK&quot;</span>) <span class="keyword">or</span> <span class="number">0</span>)&#125;</span><br><span class="line">        gradient_accumulation_steps = gradient_accumulation_steps // world_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check if parameter passed or if set within environ</span></span><br><span class="line">    use_wandb = <span class="built_in">len</span>(wandb_project) &gt; <span class="number">0</span> <span class="keyword">or</span> (</span><br><span class="line">            <span class="string">&quot;WANDB_PROJECT&quot;</span> <span class="keyword">in</span> os.environ <span class="keyword">and</span> <span class="built_in">len</span>(os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>]) &gt; <span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># Only overwrite environ if wandb param passed</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(wandb_project) &gt; <span class="number">0</span>:</span><br><span class="line">        os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>] = wandb_project</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(wandb_watch) &gt; <span class="number">0</span>:</span><br><span class="line">        os.environ[<span class="string">&quot;WANDB_WATCH&quot;</span>] = wandb_watch</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(wandb_log_model) &gt; <span class="number">0</span>:</span><br><span class="line">        os.environ[<span class="string">&quot;WANDB_LOG_MODEL&quot;</span>] = wandb_log_model</span><br><span class="line"></span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        base_model,</span><br><span class="line">        torch_dtype=torch.float16,</span><br><span class="line">        device_map=device_map,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(base_model)</span><br><span class="line"></span><br><span class="line">    tokenizer.pad_token_id = (</span><br><span class="line">        <span class="number">0</span>  <span class="comment"># unk. we want this to be different from the eos token</span></span><br><span class="line">    )</span><br><span class="line">    tokenizer.padding_side = <span class="string">&quot;left&quot;</span>  <span class="comment"># Allow batched inference</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tokenize</span>(<span class="params">prompt, add_eos_token=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="comment"># there&#x27;s probably a way to do this with the tokenizer settings</span></span><br><span class="line">        <span class="comment"># but again, gotta move fast</span></span><br><span class="line">        result = tokenizer(</span><br><span class="line">            prompt,</span><br><span class="line">            truncation=<span class="literal">True</span>,</span><br><span class="line">            max_length=cutoff_len,</span><br><span class="line">            padding=<span class="literal">False</span>,</span><br><span class="line">            return_tensors=<span class="literal">None</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">                result[<span class="string">&quot;input_ids&quot;</span>][-<span class="number">1</span>] != tokenizer.eos_token_id</span><br><span class="line">                <span class="keyword">and</span> <span class="built_in">len</span>(result[<span class="string">&quot;input_ids&quot;</span>]) &lt; cutoff_len</span><br><span class="line">                <span class="keyword">and</span> add_eos_token</span><br><span class="line">        ):</span><br><span class="line">            result[<span class="string">&quot;input_ids&quot;</span>].append(tokenizer.eos_token_id)</span><br><span class="line">            result[<span class="string">&quot;attention_mask&quot;</span>].append(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        result[<span class="string">&quot;labels&quot;</span>] = result[<span class="string">&quot;input_ids&quot;</span>].copy()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_and_tokenize_prompt</span>(<span class="params">data_point</span>):</span><br><span class="line">        full_prompt = prompter.generate_prompt(</span><br><span class="line">            data_point[<span class="string">&quot;instruction&quot;</span>],</span><br><span class="line">            data_point[<span class="string">&quot;input&quot;</span>],</span><br><span class="line">            data_point[<span class="string">&quot;output&quot;</span>],</span><br><span class="line">        )</span><br><span class="line">        tokenized_full_prompt = tokenize(full_prompt)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> train_on_inputs:</span><br><span class="line">            user_prompt = prompter.generate_prompt(</span><br><span class="line">                data_point[<span class="string">&quot;instruction&quot;</span>], data_point[<span class="string">&quot;input&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">            tokenized_user_prompt = tokenize(</span><br><span class="line">                user_prompt, add_eos_token=add_eos_token</span><br><span class="line">            )</span><br><span class="line">            user_prompt_len = <span class="built_in">len</span>(tokenized_user_prompt[<span class="string">&quot;input_ids&quot;</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> add_eos_token:</span><br><span class="line">                user_prompt_len -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            tokenized_full_prompt[<span class="string">&quot;labels&quot;</span>] = [</span><br><span class="line">                                                  -<span class="number">100</span></span><br><span class="line">                                              ] * user_prompt_len + tokenized_full_prompt[<span class="string">&quot;labels&quot;</span>][</span><br><span class="line">                                                                    user_prompt_len:</span><br><span class="line">                                                                    ]  <span class="comment"># could be sped up, probably</span></span><br><span class="line">        <span class="keyword">return</span> tokenized_full_prompt</span><br><span class="line"></span><br><span class="line">    model = prepare_model_for_int8_training(model)</span><br><span class="line"></span><br><span class="line">    config = LoraConfig(</span><br><span class="line">        r=lora_r,</span><br><span class="line">        lora_alpha=lora_alpha,</span><br><span class="line">        target_modules=lora_target_modules,</span><br><span class="line">        lora_dropout=lora_dropout,</span><br><span class="line">        bias=<span class="string">&quot;none&quot;</span>,</span><br><span class="line">        task_type=<span class="string">&quot;CAUSAL_LM&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    peft_model = get_peft_model(model, config)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> data_path.endswith(<span class="string">&quot;.json&quot;</span>) <span class="keyword">or</span> data_path.endswith(<span class="string">&quot;.jsonl&quot;</span>):  <span class="comment"># 数据是JSON或者JSONL格式</span></span><br><span class="line">        data = load_dataset(<span class="string">&quot;json&quot;</span>, data_files=data_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = load_dataset(data_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resume_from_checkpoint:</span><br><span class="line">        <span class="comment"># Check the available weights and load them</span></span><br><span class="line">        checkpoint_name = os.path.join(</span><br><span class="line">            resume_from_checkpoint, <span class="string">&quot;pytorch_model.bin&quot;</span></span><br><span class="line">        )  <span class="comment"># Full checkpoint</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(checkpoint_name):</span><br><span class="line">            checkpoint_name = os.path.join(</span><br><span class="line">                resume_from_checkpoint, <span class="string">&quot;adapter_model.bin&quot;</span></span><br><span class="line">            )  <span class="comment"># only LoRA model - LoRA config above has to fit</span></span><br><span class="line">            resume_from_checkpoint = (</span><br><span class="line">                <span class="literal">False</span>  <span class="comment"># So the trainer won&#x27;t try loading its state</span></span><br><span class="line">            )</span><br><span class="line">        <span class="comment"># The two files above have a different name depending on how they were saved, but are actually the same.</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(checkpoint_name):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Restarting from <span class="subst">&#123;checkpoint_name&#125;</span>&quot;</span>)</span><br><span class="line">            adapters_weights = torch.load(checkpoint_name)</span><br><span class="line">            set_peft_model_state_dict(peft_model, adapters_weights)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Checkpoint <span class="subst">&#123;checkpoint_name&#125;</span> not found&quot;</span>)</span><br><span class="line"></span><br><span class="line">    peft_model.print_trainable_parameters()  <span class="comment"># Be more transparent about the % of trainable params.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> val_set_size &gt; <span class="number">0</span>:</span><br><span class="line">        train_val = data[<span class="string">&quot;train&quot;</span>].train_test_split(</span><br><span class="line">            test_size=val_set_size, shuffle=<span class="literal">True</span>, seed=<span class="number">42</span></span><br><span class="line">        )</span><br><span class="line">        train_data = (</span><br><span class="line">            train_val[<span class="string">&quot;train&quot;</span>].shuffle().<span class="built_in">map</span>(generate_and_tokenize_prompt)</span><br><span class="line">        )</span><br><span class="line">        val_data = (</span><br><span class="line">            train_val[<span class="string">&quot;test&quot;</span>].shuffle().<span class="built_in">map</span>(generate_and_tokenize_prompt)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        train_data = data[<span class="string">&quot;train&quot;</span>].shuffle().<span class="built_in">map</span>(generate_and_tokenize_prompt)</span><br><span class="line">        val_data = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ddp <span class="keyword">and</span> torch.cuda.device_count() &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># keeps Trainer from trying its own DataParallelism when more than 1 gpu is available</span></span><br><span class="line">        peft_model.is_parallelizable = <span class="literal">True</span></span><br><span class="line">        peft_model.model_parallel = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    trainer = Trainer(</span><br><span class="line">        model=peft_model,</span><br><span class="line">        train_dataset=train_data,</span><br><span class="line">        eval_dataset=val_data,</span><br><span class="line">        args=TrainingArguments(</span><br><span class="line">            per_device_train_batch_size=micro_batch_size,</span><br><span class="line">            gradient_accumulation_steps=gradient_accumulation_steps,</span><br><span class="line">            warmup_steps=<span class="number">100</span>,</span><br><span class="line">            num_train_epochs=num_epochs,</span><br><span class="line">            learning_rate=learning_rate,</span><br><span class="line">            logging_steps=<span class="number">10</span>,</span><br><span class="line">            optim=<span class="string">&quot;adamw_torch&quot;</span>,</span><br><span class="line">            evaluation_strategy=<span class="string">&quot;steps&quot;</span> <span class="keyword">if</span> val_set_size &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">&quot;no&quot;</span>,</span><br><span class="line">            save_strategy=<span class="string">&quot;steps&quot;</span>,</span><br><span class="line">            eval_steps=<span class="number">200</span> <span class="keyword">if</span> val_set_size &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            save_steps=<span class="number">200</span>,</span><br><span class="line">            output_dir=output_dir,</span><br><span class="line">            save_total_limit=<span class="number">3</span>,</span><br><span class="line">            load_best_model_at_end=<span class="literal">True</span> <span class="keyword">if</span> val_set_size &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="literal">False</span>,</span><br><span class="line">            ddp_find_unused_parameters=<span class="literal">False</span> <span class="keyword">if</span> ddp <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            group_by_length=group_by_length,</span><br><span class="line">            report_to=<span class="string">&quot;wandb&quot;</span> <span class="keyword">if</span> use_wandb <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            run_name=wandb_run_name <span class="keyword">if</span> use_wandb <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">        ),</span><br><span class="line">        data_collator=DataCollatorForSeq2Seq(</span><br><span class="line">            tokenizer, pad_to_multiple_of=<span class="number">8</span>, return_tensors=<span class="string">&quot;pt&quot;</span>, padding=<span class="literal">True</span></span><br><span class="line">        ),</span><br><span class="line">    )</span><br><span class="line">    peft_model.config.use_cache = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    trainer.train(resume_from_checkpoint=resume_from_checkpoint)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># lora权重保存</span></span><br><span class="line">    trainer.model.save_pretrained(output_dir)  <span class="comment"># 保存模型向量</span></span><br><span class="line">    tokenizer.save_pretrained(output_dir)  <span class="comment"># 保存token</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># lora权重跟原始模型合并，并保存</span></span><br><span class="line">    model_to_merge = PeftModel.from_pretrained(</span><br><span class="line">        AutoModelForCausalLM.from_pretrained(base_model), output_dir)</span><br><span class="line"></span><br><span class="line">    merged_model = model_to_merge.merge_and_unload()</span><br><span class="line">    merged_model.save_pretrained(output_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    fire.Fire(train)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的模型finetune代码跟personalized_rec中的完全一样</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-5-模型效果评估">1.5 模型效果评估</h3>
<p>将平均精准率、平均召回率作为比较指标，下面是比较 1.3 中的上下文学习能力推荐的情况。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;utils&#x27;</span>)</span><br><span class="line">utils = importlib.import_module(<span class="string">&#x27;utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line">REC_MUM = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">precision</span>(<span class="params">rec_list: <span class="built_in">list</span>, action_list: <span class="built_in">list</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算单个用户推荐的精准度</span></span><br><span class="line"><span class="string">    :param rec_list: 算法的推荐列表</span></span><br><span class="line"><span class="string">    :param action_list: 用户实际的购买列表</span></span><br><span class="line"><span class="string">    :return: 精准度</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num = <span class="built_in">len</span>(<span class="built_in">set</span>(rec_list))</span><br><span class="line">    <span class="keyword">if</span> num &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="built_in">set</span>(rec_list).intersection(<span class="built_in">set</span>(action_list))) / num</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">rec_list: <span class="built_in">list</span>, action_list: <span class="built_in">list</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算单个用户推荐的召回率</span></span><br><span class="line"><span class="string">    :param rec_list: 算法的推荐列表</span></span><br><span class="line"><span class="string">    :param action_list: 用户实际的购买列表</span></span><br><span class="line"><span class="string">    :return: 召回率</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num = <span class="built_in">len</span>(<span class="built_in">set</span>(action_list))</span><br><span class="line">    <span class="keyword">if</span> num &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="built_in">set</span>(rec_list).intersection(<span class="built_in">set</span>(action_list))) / num</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_all_occurrences</span>(<span class="params">s, char</span>):</span><br><span class="line">    start = s.find(char)</span><br><span class="line">    indices = []</span><br><span class="line">    <span class="keyword">while</span> start != -<span class="number">1</span>:</span><br><span class="line">        indices.append(start)</span><br><span class="line">        start = s.find(char, start + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> indices</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">data_path: <span class="built_in">str</span>, model_type: <span class="built_in">str</span></span>) -&gt; (<span class="built_in">float</span>, <span class="built_in">float</span>):</span><br><span class="line">    test_user_dict = utils.get_user_history(data_type=<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    test_users = test_user_dict.keys()</span><br><span class="line">    j = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(data_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        j = file.read()</span><br><span class="line">    rec = json.loads(j)</span><br><span class="line"></span><br><span class="line">    common_num = <span class="number">0</span>  <span class="comment"># 推荐的用户和实际测试集的用户的交集数量</span></span><br><span class="line">    acc_p = <span class="number">0.0</span>  <span class="comment"># 累积精准度</span></span><br><span class="line">    acc_r = <span class="number">0.0</span>  <span class="comment"># 累积召回率</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> rec:</span><br><span class="line">        user = x[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">in</span> test_users:</span><br><span class="line">            common_num += <span class="number">1</span></span><br><span class="line">            action_list = test_user_dict[user]</span><br><span class="line">            temp = x[<span class="string">&#x27;rec&#x27;</span>]</span><br><span class="line">            rec_list = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> model_type == <span class="string">&#x27;llm_api&#x27;</span>:</span><br><span class="line">                rec_list = <span class="built_in">eval</span>(temp)</span><br><span class="line">            <span class="keyword">elif</span> model_type <span class="keyword">in</span> [<span class="string">&#x27;openllm&#x27;</span>, <span class="string">&#x27;openllm_finetune&#x27;</span>]:  <span class="comment"># 千问模型和微调的模型生成的结构比较复杂，需要特殊处理</span></span><br><span class="line">                <span class="comment"># print(temp)</span></span><br><span class="line">                loc_list = find_all_occurrences(temp, <span class="string">&#x27;&quot;item_id&quot;: &quot;&#x27;</span>)</span><br><span class="line">                rec_list = []</span><br><span class="line">                <span class="keyword">for</span> loc <span class="keyword">in</span> loc_list:</span><br><span class="line">                    item_id = temp[loc + <span class="built_in">len</span>(<span class="string">&#x27;&quot;item_id&quot;: &quot;&#x27;</span>): loc + <span class="built_in">len</span>(<span class="string">&#x27;&quot;item_id&quot;: &quot;&#x27;</span>) + <span class="number">10</span>]  <span class="comment"># item_id长度为10</span></span><br><span class="line">                    rec_list.append(item_id)</span><br><span class="line">                <span class="comment"># print(rec_list)</span></span><br><span class="line">            rec_list = rec_list[:REC_MUM]  <span class="comment"># 最多推荐REC_MUM，避免不同模型推荐的数量不一样，对比不公平</span></span><br><span class="line">            p = precision(rec_list, action_list)</span><br><span class="line">            r = recall(rec_list, action_list)</span><br><span class="line">            acc_p += p</span><br><span class="line">            acc_r += r</span><br><span class="line"></span><br><span class="line">    avg_p = acc_p / common_num</span><br><span class="line">    avg_r = acc_r / common_num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> avg_p, avg_r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    llm_api_avg_p, llm_api_avg_r = evaluate(<span class="string">&#x27;data/llm_api_rec.json&#x27;</span>, model_type=<span class="string">&#x27;llm_api&#x27;</span>)</span><br><span class="line">    openllm_avg_p, openllm_avg_r = evaluate(<span class="string">&#x27;data/openllm_rec.json&#x27;</span>, model_type=<span class="string">&#x27;openllm&#x27;</span>)</span><br><span class="line">    openllm_finetune_avg_p, openllm_finetune_avg_r = (</span><br><span class="line">        evaluate(<span class="string">&#x27;data/openllm_finetune_rec.json&#x27;</span>, model_type=<span class="string">&#x27;openllm_finetune&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    res = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;llm_api_avg_p&quot;</span>: llm_api_avg_p,</span><br><span class="line">            <span class="string">&quot;llm_api_avg_r&quot;</span>: llm_api_avg_r</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;openllm_avg_p&quot;</span>: openllm_avg_p,</span><br><span class="line">            <span class="string">&quot;openllm_avg_r&quot;</span>: openllm_avg_r</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;openllm_finetune_avg_p&quot;</span>: openllm_finetune_avg_p,</span><br><span class="line">            <span class="string">&quot;openllm_finetune_avg_r&quot;</span>: openllm_finetune_avg_r</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(json.dumps(res, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>最终效果发现：Qwen-4B微调模型的效果反而不如没有微调的。<br>
可能原因：</p>
<ol>
<li>微调样本数量太少，没有学习到重要的规律</li>
<li>提供的数据不够好，缺失某种特征，引入了噪声</li>
<li>模型参数比较少，根本难以解决这个问题</li>
</ol>
</blockquote>
<h2 id="2、生成用户兴趣画像">2、生成用户兴趣画像</h2>
<h2 id="3、生成个性化商品描述">3、生成个性化商品描述</h2>
<h2 id="4、猜你喜欢推荐">4、猜你喜欢推荐</h2>
<h2 id="5、电商关联推荐">5、电商关联推荐</h2>
<ul>
<li><code>also_buy</code>买了该商品的用户还买了</li>
<li><code>also_view</code>浏览了该商品的用户还浏览了</li>
<li>前者更强烈，相似度设置为2，后者设置为 1</li>
<li>负样本的相似度设置为 0</li>
<li>正负样本数量应该差不多</li>
</ul>
<h3 id="5-1-数据准备">5.1 数据准备</h3>
<p>构建训练、测试样本<code>similar_rec/data-process/generate_funetune_data.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">按照如下格式构建训练、测试数据集：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;instruction&quot;: &quot;You are a product expert who judges whether </span></span><br><span class="line"><span class="string">two products are similar based on your professional knowledge.&quot;, </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;input&quot;: &quot;I will provide you with two product related introduction information, as follows(in JSON format):</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;title&quot;: &quot;SF221-Shaving Factory Straight Razor (Black), Shaving Factory Hand Made Shaving Brush, 100...&quot;,</span></span><br><span class="line"><span class="string">        &quot;brand&quot;: &quot;Shaving Factory&quot;,</span></span><br><span class="line"><span class="string">        &quot;price&quot;: &quot;$21.95&quot;,</span></span><br><span class="line"><span class="string">        &quot;description&quot;: [&quot;Start Up combines citrus essential oils with gentle Alpha Hydroxy Acids to cleanse and refresh</span></span><br><span class="line"><span class="string">            your face. The 5% AHA level is gentle enough for all skin types.&quot;, &quot;&quot;, &quot;&quot;],</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;title&quot;: &quot;Loud &#x27;N Clear&amp;trade; Personal Sound Amplifier&quot;,</span></span><br><span class="line"><span class="string">        &quot;brand&quot;: &quot;idea village&quot;,</span></span><br><span class="line"><span class="string">        &quot;price&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">        &quot;description&quot;: [&quot;Loud &#x27;N Clear Personal Sound Amplifier allows you to turn up the volume on what people around </span></span><br><span class="line"><span class="string">            you are saying, listen at the level you want without disturbing others, hear a pin drop from across the room.&quot;],</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Based on above information, please predict if these two products are similar. The similarity  is between 0 and 2, </span></span><br><span class="line"><span class="string">0 being lowest and 2 being highest. You just need to ranking the above product, do not explain the reason.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;output&quot;: &quot;0&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">构建训练集、测试集的思路：</span></span><br><span class="line"><span class="string">基于metadata数据集中also_buy、also_view 字段，某个商品与also_buy、also_view中的商品认为是相似的，这些可以做为正样本。</span></span><br><span class="line"><span class="string">但他们的相似度应该不一样，also_buy是更强烈的偏好，我们设置相似度为2，also_view设置为1</span></span><br><span class="line"><span class="string">为了让训练样本更加平衡，可以随机选择两个商品对做为负样本，选择负样本的数量跟正样本差不多。负样本设置相似度为0。</span></span><br><span class="line"><span class="string">下面就基于这个思路来进行处理。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">instruction = (<span class="string">&quot;You are a product expert who judges whether &quot;</span></span><br><span class="line">               <span class="string">&quot;two products are similar based on your professional knowledge.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_data</span>(<span class="params">out_path: <span class="built_in">str</span>, item_dict: <span class="built_in">dict</span>, test_ratio: <span class="built_in">float</span> = <span class="number">0.3</span></span>):</span><br><span class="line">    data_list = []</span><br><span class="line">    <span class="comment"># 构建正样本</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> item_dict.keys():</span><br><span class="line"></span><br><span class="line">        info = item_dict[item]</span><br><span class="line">        title = info[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        brand = info[<span class="string">&#x27;brand&#x27;</span>]</span><br><span class="line">        price = info[<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">        description = info[<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">        also_view = info[<span class="string">&#x27;also_view&#x27;</span>]</span><br><span class="line">        also_buy = info[<span class="string">&#x27;also_buy&#x27;</span>]</span><br><span class="line">        _<span class="built_in">dict</span> = &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">            <span class="string">&quot;brand&quot;</span>: brand,</span><br><span class="line">            <span class="string">&quot;price&quot;</span>: price,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: description</span><br><span class="line">        &#125;</span><br><span class="line">        s = <span class="built_in">set</span>(also_view).union(<span class="built_in">set</span>(also_buy))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> item_dict:</span><br><span class="line">                i_dict = &#123;</span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: item_dict[i][<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;brand&quot;</span>: item_dict[i][<span class="string">&#x27;brand&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;price&quot;</span>: item_dict[i][<span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: item_dict[i][<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                positive_sample_pair = [_<span class="built_in">dict</span>, i_dict]</span><br><span class="line">                formatted_input = json.dumps(positive_sample_pair, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">                <span class="built_in">input</span> = (<span class="string">&quot;I will provide you with two product related introduction information, as follows(in JSON &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;format):\n\n&quot;</span> +</span><br><span class="line">                         formatted_input + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                         <span class="string">&quot;Based on above information, please predict if these two products are similar. The similarity &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;is between 0 and 2, 0 being lowest and 2 being highest. You just need to ranking the above &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;product, do not explain the reason.&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> also_buy:</span><br><span class="line">                    output = <span class="string">&quot;2&quot;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    output = <span class="string">&quot;1&quot;</span></span><br><span class="line">                res_dic = &#123;</span><br><span class="line">                    <span class="string">&quot;instruction&quot;</span>: instruction,</span><br><span class="line">                    <span class="string">&quot;input&quot;</span>: <span class="built_in">input</span>,</span><br><span class="line">                    <span class="string">&quot;output&quot;</span>: output</span><br><span class="line">                &#125;</span><br><span class="line">                data_list.append(res_dic)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建负样本</span></span><br><span class="line">    positive_sample_num = <span class="built_in">len</span>(data_list)</span><br><span class="line">    item_set = item_dict.keys()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(positive_sample_num):</span><br><span class="line">        negative_sample_pair = random.sample(item_set, <span class="number">2</span>)  <span class="comment"># [1, 2]</span></span><br><span class="line">        a_dict = &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: item_dict[negative_sample_pair[<span class="number">0</span>]][<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;brand&quot;</span>: item_dict[negative_sample_pair[<span class="number">0</span>]][<span class="string">&#x27;brand&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;price&quot;</span>: item_dict[negative_sample_pair[<span class="number">0</span>]][<span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: item_dict[negative_sample_pair[<span class="number">0</span>]][<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        b_dict = &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: item_dict[negative_sample_pair[<span class="number">1</span>]][<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;brand&quot;</span>: item_dict[negative_sample_pair[<span class="number">1</span>]][<span class="string">&#x27;brand&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;price&quot;</span>: item_dict[negative_sample_pair[<span class="number">1</span>]][<span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: item_dict[negative_sample_pair[<span class="number">1</span>]][<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        negative_sample_pair = [a_dict, b_dict]</span><br><span class="line">        formatted_input = json.dumps(negative_sample_pair, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="built_in">input</span> = (<span class="string">&quot;I will provide you with two product related introduction information, as follows(in JSON &quot;</span> +</span><br><span class="line">                 <span class="string">&quot;format):\n\n&quot;</span> +</span><br><span class="line">                 formatted_input + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                 <span class="string">&quot;Based on above information, please predict if these two products are similar. The similarity &quot;</span> +</span><br><span class="line">                 <span class="string">&quot;is between 0 and 2, 0 being lowest and 2 being highest. You just need to ranking the above &quot;</span> +</span><br><span class="line">                 <span class="string">&quot;product, do not explain the reason.&quot;</span>)</span><br><span class="line">        res_dic = &#123;</span><br><span class="line">            <span class="string">&quot;instruction&quot;</span>: instruction,</span><br><span class="line">            <span class="string">&quot;input&quot;</span>: <span class="built_in">input</span>,</span><br><span class="line">            <span class="string">&quot;output&quot;</span>: <span class="string">&quot;0&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        data_list.append(res_dic)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将数据拆分为训练集和测试集</span></span><br><span class="line">    random.shuffle(data_list)</span><br><span class="line">    split_loc = <span class="built_in">int</span>(<span class="built_in">len</span>(data_list) * test_ratio)</span><br><span class="line">    test_data_list = data_list[<span class="number">0</span>: split_loc]</span><br><span class="line">    train_data_list = data_list[split_loc:]</span><br><span class="line">    test_res = json.dumps(test_data_list, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    train_res = json.dumps(train_data_list, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(out_path + <span class="string">&quot;/test.json&quot;</span>, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file_:  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line">        file_.write(test_res)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(out_path + <span class="string">&quot;/train.json&quot;</span>, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> file_:  <span class="comment"># 将生成的训练数据保存起来</span></span><br><span class="line">        file_.write(train_res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> generate_item_dict <span class="keyword">import</span> get_metadata_dict</span><br><span class="line"></span><br><span class="line">item_dict = get_metadata_dict()</span><br><span class="line">generate_data(<span class="string">&quot;../data&quot;</span>, item_dict, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    目前train.json 4616个样本。</span></span><br><span class="line"><span class="string">    目前test.json 3706个样本。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>下面为每个商品生成相关的信息字典。<br>
代码<code>similar_rec/data-process/generate_item_dict.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_metadata_dict</span>(<span class="params">path: <span class="built_in">str</span> = <span class="string">&#x27;../../data/amazon_review/beauty/meta_All_Beauty.json&#x27;</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    item_dict = &#123;&#125;  <span class="comment"># meta_All_Beauty.json中获取每个item对应的信息</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;&quot;category&quot;: [], &quot;tech1&quot;: &quot;&quot;, &quot;description&quot;: [&quot;Start Up combines citrus essential oils with gentle Alpha Hydroxy Acids to cleanse and refresh your face. The 5% AHA level is gentle enough for all skin types.&quot;, &quot;&quot;, &quot;&quot;], </span></span><br><span class="line"><span class="string">    &quot;fit&quot;: &quot;&quot;, &quot;title&quot;: &quot;Kiss My Face Exfoliating Face Wash Start Up, 4 Fluid Ounce&quot;, </span></span><br><span class="line"><span class="string">    &quot;also_buy&quot;: [&quot;B000Z96JDI&quot;, &quot;B00006IGL8&quot;, &quot;B007C5X34G&quot;, &quot;B00006IGLF&quot;, &quot;B00213WCNC&quot;, &quot;B00D1W1QXE&quot;, &quot;B001FB5HZG&quot;, &quot;B000FQ86RI&quot;, &quot;B0012BSKBM&quot;, &quot;B0085EVLRO&quot;, &quot;B00A2EXVQE&quot;], </span></span><br><span class="line"><span class="string">    &quot;tech2&quot;: &quot;&quot;, &quot;brand&quot;: &quot;Kiss My Face&quot;, &quot;feature&quot;: [], &quot;rank&quot;: [], </span></span><br><span class="line"><span class="string">    &quot;also_view&quot;: [&quot;B000Z96JDI&quot;, &quot;B001FB5HZG&quot;, &quot;B00213WCNC&quot;, &quot;B00BBFOVO4&quot;, &quot;B0085EVLRO&quot;], </span></span><br><span class="line"><span class="string">    &quot;details&quot;: &#123;&quot;\n    Product Dimensions: \n    &quot;: &quot;2.5 x 1.6 x 7 inches ; 4 ounces&quot;, &quot;Shipping Weight:&quot;: &quot;4 ounces&quot;, &quot;ASIN: &quot;: &quot;B00006IGL2&quot;, &quot;UPC:&quot;: &quot;890795851488 701320351987 601669038184 793379218755 028367831938 787734768894 756769626417&quot;, &quot;Item model number:&quot;: &quot;1200040&quot;&#125;,</span></span><br><span class="line"><span class="string">     &quot;main_cat&quot;: &quot;All Beauty&quot;, &quot;similar_item&quot;: &quot;&quot;, &quot;date&quot;: &quot;&quot;, &quot;price&quot;: &quot;&quot;, </span></span><br><span class="line"><span class="string">     &quot;asin&quot;: &quot;B00006IGL2&quot;, &quot;imageURL&quot;: [&quot;https://images-na.ssl-images-amazon.com/images/I/41i07fBAznL._SS40_.jpg&quot;, </span></span><br><span class="line"><span class="string">     &quot;https://images-na.ssl-images-amazon.com/images/I/31W8DZRVD1L._SS40_.jpg&quot;], &quot;imageURLHighRes&quot;: [&quot;https://images-na.ssl-images-amazon.com/images/I/41i07fBAznL.jpg&quot;, &quot;https://images-na.ssl-images-amazon.com/images/I/31W8DZRVD1L.jpg&quot;]&#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        reader = csv.reader(file, delimiter=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">            j = json.loads(row[<span class="number">0</span>])</span><br><span class="line">            item_id = j[<span class="string">&#x27;asin&#x27;</span>]</span><br><span class="line">            title = j[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">            brand = j[<span class="string">&#x27;brand&#x27;</span>]</span><br><span class="line">            description = j[<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">            price = j[<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">            also_buy = j[<span class="string">&#x27;also_buy&#x27;</span>]</span><br><span class="line">            also_view = j[<span class="string">&#x27;also_view&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> price != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> <span class="string">&#x27;$&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> price <span class="keyword">and</span> <span class="built_in">len</span>(price) &gt; <span class="number">10</span>:  <span class="comment"># 处理一些异常数据情况</span></span><br><span class="line">                price = <span class="string">&quot;&quot;</span></span><br><span class="line">            item_info = &#123;</span><br><span class="line">                <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">                <span class="string">&quot;brand&quot;</span>: brand,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">                <span class="string">&quot;also_buy&quot;</span>: also_buy,</span><br><span class="line">                <span class="string">&quot;also_view&quot;</span>: also_view,</span><br><span class="line">                <span class="string">&quot;price&quot;</span>: price</span><br><span class="line">            &#125;</span><br><span class="line">            item_dict[item_id] = item_info</span><br><span class="line">    <span class="keyword">return</span> item_dict</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="5-2-多路召回">5.2 多路召回</h3>
<p>下面是基于：</p>
<ol>
<li>标签 <code>brand</code></li>
<li>同时购买<code>also_buy</code></li>
<li>同时浏览<code>also_view</code></li>
<li>嵌入相似<br>
四个召回算法的。</li>
</ol>
<p>代码<code>similar_rec/recall_items.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;./data-process&#x27;</span>)</span><br><span class="line">generate_item_dict = importlib.import_module(<span class="string">&#x27;generate_item_dict&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tags_recall</span>(<span class="params">item_id: <span class="built_in">str</span>, item_dict: <span class="built_in">dict</span></span>) -&gt; [<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    基于商品的标签召回，本算法利用brand进行召回，召回的item是brand跟item_id一样的商品</span></span><br><span class="line"><span class="string">    :param item_dict: 商品metadata的字典信息</span></span><br><span class="line"><span class="string">    :param item_id: 商品id</span></span><br><span class="line"><span class="string">    :return: 召回的item列表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    brand = item_dict[item_id][<span class="string">&#x27;brand&#x27;</span>]</span><br><span class="line">    recall_list = []</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> item_dict.items():</span><br><span class="line">        <span class="keyword">if</span> value[<span class="string">&#x27;brand&#x27;</span>] == brand <span class="keyword">and</span> key != item_id:</span><br><span class="line">            recall_list.append(key)</span><br><span class="line">    <span class="keyword">return</span> recall_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">embedding_recall</span>(<span class="params">item_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     item_dict: <span class="built_in">dict</span>,</span></span><br><span class="line"><span class="params">                     recall_num: <span class="built_in">int</span> = <span class="number">20</span>,</span></span><br><span class="line"><span class="params">                     min_similar_score: <span class="built_in">float</span> = <span class="number">0.8</span></span>) -&gt; [<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    利用商品的文本数据进行嵌入，利用嵌入向量召回</span></span><br><span class="line"><span class="string">    :param min_similar_score: 最底的相似得分，大于这个得分就可以做为召回了</span></span><br><span class="line"><span class="string">    :param recall_num: 召回的数量，默认是20个</span></span><br><span class="line"><span class="string">    :param item_dict: 商品metadata的字典信息</span></span><br><span class="line"><span class="string">    :param item_id: 商品id</span></span><br><span class="line"><span class="string">    :return: 召回的item列表</span></span><br><span class="line"><span class="string">    本函数只是一个方法式例，的实现效率不是很高，更好的实现方式是提前将所有商品的embedding计算出来并且放到faiss库（或者其它向量库）中，</span></span><br><span class="line"><span class="string">    这样可以获得毫秒级的召回效率</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = SentenceTransformer(<span class="string">&#x27;/Users/liuqiang/Desktop/code/llm/models/bge-large-en-v1.5&#x27;</span>)</span><br><span class="line">    item_title = item_dict[item_id][<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">    item_desc = item_dict[item_id][<span class="string">&#x27;description&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">    item_info = <span class="string">&quot;title: &quot;</span> + item_title + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;description: &quot;</span> + item_desc</span><br><span class="line">    sentences_1 = [item_info]</span><br><span class="line">    embeddings_1 = model.encode(sentences_1, normalize_embeddings=<span class="literal">True</span>)</span><br><span class="line">    similar_list = []</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> item_dict.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(similar_list) &lt; recall_num <span class="keyword">and</span> key != item_id <span class="keyword">and</span> value[<span class="string">&#x27;description&#x27;</span>]:</span><br><span class="line">            title = value[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">            desc = value[<span class="string">&#x27;description&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">            info = <span class="string">&quot;title: &quot;</span> + title + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;description: &quot;</span> + desc</span><br><span class="line">            sentences_2 = [info]</span><br><span class="line">            embeddings_2 = model.encode(sentences_2, normalize_embeddings=<span class="literal">True</span>)</span><br><span class="line">            similarity = embeddings_1 @ embeddings_2.T</span><br><span class="line">            <span class="keyword">if</span> similarity[<span class="number">0</span>][<span class="number">0</span>] &gt; min_similar_score:</span><br><span class="line">                similar_list.append((key, similarity[<span class="number">0</span>][<span class="number">0</span>]))</span><br><span class="line">    similar_list.sort(key=operator.itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)</span><br><span class="line">    slice_list = similar_list[<span class="number">0</span>: recall_num]</span><br><span class="line">    <span class="keyword">return</span> [x[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> slice_list]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">also_buy_recall</span>(<span class="params">item_id: <span class="built_in">str</span>, item_dict: <span class="built_in">dict</span></span>) -&gt; [<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    亚马逊电商数据集中商品metadata中包含also_buy字段，这个字段就是跟该商品一起买的商品，可以做为召回</span></span><br><span class="line"><span class="string">    :param item_dict: 商品metadata的字典信息</span></span><br><span class="line"><span class="string">    :param item_id: 商品id</span></span><br><span class="line"><span class="string">    :return: 召回的item列表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    also_buy_list = item_dict[item_id][<span class="string">&#x27;also_buy&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> also_buy_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">also_view_recall</span>(<span class="params">item_id: <span class="built_in">str</span>, item_dict: <span class="built_in">dict</span></span>) -&gt; [<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    亚马逊电商数据集中商品metadata中包含also_view字段，这个字段就是跟该商品一起被用户浏览的商品，可以做为召回来源</span></span><br><span class="line"><span class="string">    :param item_dict: 商品metadata的字典信息</span></span><br><span class="line"><span class="string">    :param item_id: 商品id</span></span><br><span class="line"><span class="string">    :return: 召回的item列表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    also_view_list = item_dict[item_id][<span class="string">&#x27;also_view&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> also_view_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    dic = generate_item_dict.get_metadata_dict()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(embedding_recall(<span class="string">&quot;B00006IGL2&quot;</span>, dic, <span class="number">10</span>, <span class="number">0.75</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="5-3-相似度排序">5.3 相似度排序</h3>
<p>两种方法：</p>
<ol>
<li>基于 rerank 模型的排序</li>
<li>基于微调后的大模型的排序</li>
</ol>
<p>代码<code>similar_rec/similar_ranking.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> CrossEncoder</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModelForCausalLM</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;./data-process&#x27;</span>)</span><br><span class="line">generate_item_dict = importlib.import_module(<span class="string">&#x27;generate_item_dict&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cross_encoder_rerank</span>(<span class="params">item_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                         recall_list: [[<span class="built_in">str</span>]],</span></span><br><span class="line"><span class="params">                         item_dict: <span class="built_in">dict</span>,</span></span><br><span class="line"><span class="params">                         top_n: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; [<span class="built_in">dict</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param item_id: 待推荐的商品id，我们会给该商品关联相关的商品做为相似推荐</span></span><br><span class="line"><span class="string">    :param recall_list: 召回的商品列表</span></span><br><span class="line"><span class="string">    :param item_dict: 商品信息字典</span></span><br><span class="line"><span class="string">    :param top_n: 最终相似的商品的数量，默认值为10</span></span><br><span class="line"><span class="string">    :return: 最终排序后的相似结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    all_recall_items = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">for</span> lst <span class="keyword">in</span> recall_list:</span><br><span class="line">        all_recall_items = all_recall_items.union(<span class="built_in">set</span>(lst))</span><br><span class="line">    model = CrossEncoder(model_name=<span class="string">&#x27;/Users/liuqiang/Desktop/code/llm/models/bge-reranker-large&#x27;</span>,</span><br><span class="line">                         max_length=<span class="number">512</span>, device=<span class="string">&quot;mps&quot;</span>)</span><br><span class="line"></span><br><span class="line">    item_title = item_dict[item_id][<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">    item_desc = item_dict[item_id][<span class="string">&#x27;description&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">    item_info = <span class="string">&quot;title: &quot;</span> + item_title + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;description: &quot;</span> + item_desc</span><br><span class="line">    sentence_list = []</span><br><span class="line">    item_list = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> all_recall_items:</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">in</span> item_dict:</span><br><span class="line">            title = item_dict[item][<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">            desc = item_dict[item][<span class="string">&#x27;description&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">            info = <span class="string">&quot;title: &quot;</span> + title + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;description: &quot;</span> + desc</span><br><span class="line">            sentence_list.append(info)</span><br><span class="line">            item_list.append(item)</span><br><span class="line">    sentence_pairs = [[item_info, _sent] <span class="keyword">for</span> _sent <span class="keyword">in</span> sentence_list]</span><br><span class="line">    results = model.predict(sentences=sentence_pairs,</span><br><span class="line">                            batch_size=<span class="number">32</span>,</span><br><span class="line">                            num_workers=<span class="number">0</span>,</span><br><span class="line">                            convert_to_tensor=<span class="literal">True</span></span><br><span class="line">                            )</span><br><span class="line">    top_k = top_n <span class="keyword">if</span> top_n &lt; <span class="built_in">len</span>(results) <span class="keyword">else</span> <span class="built_in">len</span>(results)</span><br><span class="line">    values, indices = results.topk(top_k)</span><br><span class="line">    final_results = []</span><br><span class="line">    <span class="keyword">for</span> value, index <span class="keyword">in</span> <span class="built_in">zip</span>(values, indices):</span><br><span class="line">        item = item_list[index]</span><br><span class="line">        score = value.item()</span><br><span class="line">        doc = &#123;</span><br><span class="line">            <span class="string">&quot;item&quot;</span>: item,</span><br><span class="line">            <span class="string">&quot;score&quot;</span>: score</span><br><span class="line">        &#125;</span><br><span class="line">        final_results.append(doc)</span><br><span class="line">    <span class="keyword">return</span> final_results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_rerank</span>(<span class="params">item_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">               recall_list: [[<span class="built_in">str</span>]],</span></span><br><span class="line"><span class="params">               item_dict: <span class="built_in">dict</span>,</span></span><br><span class="line"><span class="params">               top_n: <span class="built_in">int</span> = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">               model_path: <span class="built_in">str</span> = <span class="string">&#x27;./models&#x27;</span></span>) -&gt; [<span class="built_in">dict</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param model_path: 预训练好的模型的存储路径</span></span><br><span class="line"><span class="string">    :param item_id: 待推荐的商品id，我们会给该商品关联相关的商品做为相似推荐</span></span><br><span class="line"><span class="string">    :param recall_list: 召回的商品列表</span></span><br><span class="line"><span class="string">    :param item_dict: 商品信息字典</span></span><br><span class="line"><span class="string">    :param top_n: 最终相似的商品的数量，默认值为10</span></span><br><span class="line"><span class="string">    :return: 最终排序后的相似结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(model_path)</span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        model_path,</span><br><span class="line">        device_map=<span class="string">&quot;auto&quot;</span>,</span><br><span class="line">        torch_dtype=torch.float16,</span><br><span class="line">    )</span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">    tokenizer.padding_side = <span class="string">&#x27;right&#x27;</span></span><br><span class="line"></span><br><span class="line">    instruction = (<span class="string">&quot;You are a product expert who judges whether &quot;</span></span><br><span class="line">                   <span class="string">&quot;two products are similar based on your professional knowledge.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    all_recall_items = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">for</span> lst <span class="keyword">in</span> recall_list:</span><br><span class="line">        all_recall_items = all_recall_items.union(<span class="built_in">set</span>(lst))</span><br><span class="line"></span><br><span class="line">    a_dict = &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: item_dict[item_id][<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">        <span class="string">&quot;brand&quot;</span>: item_dict[item_id][<span class="string">&#x27;brand&#x27;</span>],</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: item_dict[item_id][<span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: item_dict[item_id][<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> all_recall_items:</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">in</span> item_dict:</span><br><span class="line">            b_dict = &#123;</span><br><span class="line">                <span class="string">&quot;title&quot;</span>: item_dict[item][<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">                <span class="string">&quot;brand&quot;</span>: item_dict[item][<span class="string">&#x27;brand&#x27;</span>],</span><br><span class="line">                <span class="string">&quot;price&quot;</span>: item_dict[item][<span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: item_dict[item][<span class="string">&#x27;description&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            sample_pair = [a_dict, b_dict]</span><br><span class="line">            formatted_input = json.dumps(sample_pair, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            <span class="built_in">input</span> = (<span class="string">&quot;I will provide you with two product related introduction information, as follows(in JSON &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;format):\n\n&quot;</span> +</span><br><span class="line">                     formatted_input + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                     <span class="string">&quot;Based on above information, please predict if these two products are similar. The similarity &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;is between 0 and 1, 0 being lowest and 1 being highest. You just need to ranking the above &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;product, do not explain the reason.&quot;</span>)</span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;### Instruction:</span></span><br><span class="line"><span class="string">            <span class="subst">&#123;instruction&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            ### Input:</span></span><br><span class="line"><span class="string">            <span class="subst">&#123;<span class="built_in">input</span>&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            ### Response:</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            input_ids = tokenizer(prompt, return_tensors=<span class="string">&quot;pt&quot;</span>, truncation=<span class="literal">True</span>).input_ids</span><br><span class="line">            outputs = model.generate(input_ids=input_ids.to(<span class="string">&#x27;mps&#x27;</span>),</span><br><span class="line">                                     max_new_tokens=<span class="number">500</span>, pad_token_id=tokenizer.eos_token_id)</span><br><span class="line">            predict_output = tokenizer.batch_decode(outputs, skip_special_tokens=<span class="literal">True</span>)[<span class="number">0</span>][<span class="built_in">len</span>(prompt):]</span><br><span class="line">            doc = &#123;</span><br><span class="line">                <span class="string">&quot;item&quot;</span>: item,</span><br><span class="line">                <span class="string">&quot;score&quot;</span>: <span class="built_in">float</span>(predict_output)</span><br><span class="line">            &#125;</span><br><span class="line">            results.append(doc)</span><br><span class="line"></span><br><span class="line">    sorted_list = <span class="built_in">sorted</span>(results, key=operator.itemgetter(<span class="string">&#x27;score&#x27;</span>), reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> sorted_list[:top_n]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    embedding_recall = [<span class="string">&#x27;B000052YPP&#x27;</span>, <span class="string">&#x27;B00005308B&#x27;</span>, <span class="string">&#x27;B0000530HZ&#x27;</span>, <span class="string">&#x27;B000052YD8&#x27;</span>, <span class="string">&#x27;B00005308M&#x27;</span>, <span class="string">&#x27;B000052YMO&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;9790787006&#x27;</span>, <span class="string">&#x27;6546546450&#x27;</span>, <span class="string">&#x27;9744914572&#x27;</span>, <span class="string">&#x27;7414204790&#x27;</span>]</span><br><span class="line">    also_view_recall = [<span class="string">&#x27;B000Z96JDI&#x27;</span>, <span class="string">&#x27;B001FB5HZG&#x27;</span>, <span class="string">&#x27;B00213WCNC&#x27;</span>, <span class="string">&#x27;B00BBFOVO4&#x27;</span>, <span class="string">&#x27;B0085EVLRO&#x27;</span>]</span><br><span class="line">    also_buy_recall = [<span class="string">&#x27;B000Z96JDI&#x27;</span>, <span class="string">&#x27;B00006IGL8&#x27;</span>, <span class="string">&#x27;B007C5X34G&#x27;</span>, <span class="string">&#x27;B00006IGLF&#x27;</span>, <span class="string">&#x27;B00213WCNC&#x27;</span>, <span class="string">&#x27;B00D1W1QXE&#x27;</span>, <span class="string">&#x27;B001FB5HZG&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;B000FQ86RI&#x27;</span>, <span class="string">&#x27;B0012BSKBM&#x27;</span>, <span class="string">&#x27;B0085EVLRO&#x27;</span>, <span class="string">&#x27;B00A2EXVQE&#x27;</span>]</span><br><span class="line">    band_recall = [<span class="string">&#x27;B00028EYZW&#x27;</span>, <span class="string">&#x27;B001E0T0HE&#x27;</span>, <span class="string">&#x27;B00FTBJ6HI&#x27;</span>, <span class="string">&#x27;B00KLDU08S&#x27;</span>, <span class="string">&#x27;B00OQQWU4I&#x27;</span>]</span><br><span class="line">    dic = generate_item_dict.get_metadata_dict(<span class="string">&#x27;../data/amazon_review/beauty/meta_All_Beauty.json&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(&quot;----------&quot;)</span></span><br><span class="line">    <span class="comment"># res = cross_encoder_rerank(&quot;B00006IGL2&quot;,</span></span><br><span class="line">    <span class="comment">#                            [embedding_recall, also_buy_recall, also_view_recall, band_recall],</span></span><br><span class="line">    <span class="comment">#                            item_dict, 10)</span></span><br><span class="line">    <span class="comment"># print(json.dumps(res, indent=4, ensure_ascii=False))</span></span><br><span class="line">    <span class="comment"># print(&quot;----------&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line">    res = llm_rerank(<span class="string">&quot;B00006IGL2&quot;</span>,</span><br><span class="line">                     [embedding_recall, also_buy_recall, also_view_recall, band_recall],</span><br><span class="line">                     dic, <span class="number">10</span>, <span class="string">&#x27;./models&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(res, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-4-效果评估">5.4 效果评估</h3>
<p>预测相似度（0-2），利用 RMSE 指标评估<br>
代码<code>similar_rec/evaluate.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> fire</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModelForCausalLM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_json</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        json.loads(text)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_float</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">float</span>(s)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rmse</span>(<span class="params">_true, _predict</span>):</span><br><span class="line">    <span class="keyword">return</span> math.sqrt(math.fabs(_true - _predict))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">output_format</span>(<span class="params">output</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param output: 大模型的输出</span></span><br><span class="line"><span class="string">    :return: int</span></span><br><span class="line"><span class="string">    没有微调过的大模型输出的可能不是按照规范的，需要获得大模型对应的输出，下面是4个大模型的输出案例。</span></span><br><span class="line"><span class="string">    1.  The similarity between these two products is 0.5.</span></span><br><span class="line"><span class="string">    2. The similarity between the two products is 0.5. The reason is that both products are from the same brand, Royal</span></span><br><span class="line"><span class="string">    Moroccan, and they have similar descriptions, such as repairing damage caused by chemicals and restoring lustre to</span></span><br><span class="line"><span class="string">    dry and damaged locks. However, the price and capacity of the two products are different, which may affect the similarity score.</span></span><br><span class="line"><span class="string">    3. 0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="string">    4.  [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;product\_1&quot;: &quot;Shiseido Pureness Moisturizing Gel (Oil Free) 50ml/1.7oz&quot;,</span></span><br><span class="line"><span class="string">                &quot;product\_2&quot;: &quot;Mesh Full Body Sling with Commode Opening Size: Extra Large&quot;,</span></span><br><span class="line"><span class="string">                &quot;similarity&quot;: 0</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;product\_1&quot;: &quot;Shiseido Pureness Moisturizing Gel (Oil Free) 50ml/1.7oz&quot;,</span></span><br><span class="line"><span class="string">                &quot;product\_2&quot;: &quot;Mesh Full Body Sling with Commode Opening Size: Large&quot;,</span></span><br><span class="line"><span class="string">                &quot;similarity&quot;: 0</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    output = output[:<span class="number">1000</span>]  <span class="comment"># 只取前面的1000个字符，后面如果有生成额外的不考虑</span></span><br><span class="line">    <span class="keyword">if</span> is_float(output[<span class="number">0</span>:<span class="number">2</span>]):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">float</span>(output[<span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">    string_1 = <span class="string">&#x27;The similarity between the two products is &#x27;</span></span><br><span class="line">    string_2 = <span class="string">&#x27;The similarity between these two products is &#x27;</span></span><br><span class="line">    string_3 = <span class="string">&#x27;&quot;similarity&quot;: &#x27;</span></span><br><span class="line">    index_1 = output.find(string_1)  <span class="comment"># 如果找不到，返回-1</span></span><br><span class="line">    index_2 = output.find(string_2)  <span class="comment"># 如果找不到，返回-1</span></span><br><span class="line">    index_3 = output.find(string_3)  <span class="comment"># 如果找不到，返回-1</span></span><br><span class="line">    <span class="keyword">if</span> index_1 &gt; -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> is_float(output[index_1 + <span class="built_in">len</span>(string_1):index_1 + <span class="built_in">len</span>(string_1) + <span class="number">2</span>]):</span><br><span class="line">            score = <span class="built_in">float</span>(output[index_1 + <span class="built_in">len</span>(string_1):index_1 + <span class="built_in">len</span>(string_1) + <span class="number">2</span>])</span><br><span class="line">            <span class="keyword">return</span> score</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> index_2 &gt; -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> is_float(output[index_2 + <span class="built_in">len</span>(string_2):index_2 + <span class="built_in">len</span>(string_2) + <span class="number">2</span>]):</span><br><span class="line">            score = <span class="built_in">float</span>(output[index_2 + <span class="built_in">len</span>(string_2):index_2 + <span class="built_in">len</span>(string_2) + <span class="number">2</span>])</span><br><span class="line">            <span class="keyword">return</span> score</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> index_3 &gt; -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> is_float(output[index_3 + <span class="built_in">len</span>(string_3):index_3 + <span class="built_in">len</span>(string_3) + <span class="number">2</span>]):</span><br><span class="line">            score = <span class="built_in">float</span>(output[index_3 + <span class="built_in">len</span>(string_3):index_3 + <span class="built_in">len</span>(string_3) + <span class="number">2</span>])</span><br><span class="line">            <span class="keyword">return</span> score</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_model_token</span>(<span class="params">model_path: <span class="built_in">str</span></span>) -&gt; (AutoModelForCausalLM, AutoTokenizer):</span><br><span class="line">    <span class="comment"># Load model and tokenizer</span></span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        model_path,</span><br><span class="line">        device_map=<span class="string">&quot;auto&quot;</span>,</span><br><span class="line">        torch_dtype=torch.float16,</span><br><span class="line">    )</span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">    tokenizer.padding_side = <span class="string">&#x27;right&#x27;</span>  <span class="comment"># to prevent warnings</span></span><br><span class="line">    <span class="keyword">return</span> model, tokenizer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">model_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">             test_data_path: <span class="built_in">str</span> = <span class="string">&#x27;./data&#x27;</span>,</span></span><br><span class="line"><span class="params">             keep_sample_num: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    model, tokenizer = load_model_token(model_path)</span><br><span class="line"></span><br><span class="line">    dataset_dict = load_dataset(test_data_path)</span><br><span class="line">    test_dataset = dataset_dict[<span class="string">&#x27;test&#x27;</span>][<span class="number">0</span>:keep_sample_num]</span><br><span class="line"></span><br><span class="line">    acc_rmse = <span class="number">0.0</span>  <span class="comment"># 累积误差</span></span><br><span class="line">    acc_num = <span class="number">0</span>  <span class="comment"># 累积的参与统计的样本数量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(keep_sample_num):</span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;### Instruction:</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;test_dataset[<span class="string">&#x27;instruction&#x27;</span>][i]&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        ### Input:</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;test_dataset[<span class="string">&#x27;input&#x27;</span>][i]&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        ### Response:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        gold_output = <span class="built_in">float</span>(test_dataset[<span class="string">&#x27;output&#x27;</span>][i])</span><br><span class="line">        input_ids = tokenizer(prompt, return_tensors=<span class="string">&quot;pt&quot;</span>, truncation=<span class="literal">True</span>).input_ids</span><br><span class="line">        outputs = model.generate(input_ids=input_ids.to(<span class="string">&#x27;mps&#x27;</span>),</span><br><span class="line">                                 max_new_tokens=<span class="number">500</span>, pad_token_id=tokenizer.eos_token_id)</span><br><span class="line">        predict_output = tokenizer.batch_decode(outputs, skip_special_tokens=<span class="literal">True</span>)[<span class="number">0</span>][<span class="built_in">len</span>(prompt):]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;--------sample: &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;--------&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;预测的输出: &quot;</span> + predict_output + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        score = output_format(predict_output)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;预测的score: &quot;</span> + <span class="built_in">str</span>(score) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> score == -<span class="number">1</span>:  <span class="comment"># 生成的比较复杂，没有解析到对应的预测评分</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            acc_num += <span class="number">1</span></span><br><span class="line">            predict_output = score</span><br><span class="line">            rmse_ = rmse(gold_output, predict_output)</span><br><span class="line">            acc_rmse += rmse_</span><br><span class="line">            dic = &#123;  <span class="comment"># 将每一个样本的评估结果打印出来</span></span><br><span class="line">                <span class="string">&quot;sample&quot;</span>: i,</span><br><span class="line">                <span class="string">&quot;input&quot;</span>: test_dataset[<span class="string">&#x27;input&#x27;</span>][i],</span><br><span class="line">                <span class="string">&quot;gold_output&quot;</span>: gold_output,</span><br><span class="line">                <span class="string">&quot;predict_output&quot;</span>: predict_output,</span><br><span class="line">                <span class="string">&quot;rmse&quot;</span>: rmse_</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(json.dumps(dic, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;----------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> acc_rmse / acc_num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">effect_comparison</span>(<span class="params">base_model_path: <span class="built_in">str</span> = <span class="string">&#x27;/Users/liuqiang/Desktop/code/llm/models/Qwen1.5-4B&#x27;</span>,</span></span><br><span class="line"><span class="params">                      finetune_model_path: <span class="built_in">str</span> = <span class="string">&#x27;./models&#x27;</span>,</span></span><br><span class="line"><span class="params">                      test_data_path: <span class="built_in">str</span> = <span class="string">&#x27;./data&#x27;</span>,</span></span><br><span class="line"><span class="params">                      keep_sample_num: <span class="built_in">int</span> = <span class="number">10</span></span>):</span><br><span class="line">    avg_base_rmse = evaluate(base_model_path, test_data_path, keep_sample_num)</span><br><span class="line">    avg_finetune_rmse = evaluate(finetune_model_path, test_data_path, keep_sample_num)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;基底模型的平均rmse：&quot;</span> + <span class="built_in">str</span>(avg_base_rmse))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;微调模型的平均rmse：&quot;</span> + <span class="built_in">str</span>(avg_finetune_rmse))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    fire.Fire(effect_comparison)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="6、推荐解释">6、推荐解释</h2>
<h2 id="7、对话式推荐">7、对话式推荐</h2>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://isSeymour.github.io/butterflyblog">isSeymour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://isseymour.github.io/butterflyblog/2025/04/27/LLM4Rec_abc_5/">https://isseymour.github.io/butterflyblog/2025/04/27/LLM4Rec_abc_5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://isSeymour.github.io/butterflyblog" target="_blank">isSeymour</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/butterflyblog/tags/LLM/">LLM</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/5/llm4rec-abc-5-Page.webp" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY1.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY1.jpg" alt="微信支付"/></a><div class="post-qr-code-desc">微信支付</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY2.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY2.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_4/" title="大模型推荐系统（4）直接推荐范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">大模型推荐系统（4）直接推荐范式</div></div></a></div><div class="next-post pull-right"><a href="/butterflyblog/2025/07/22/Attention-is-all-you-need/" title="Transformer 开山之作"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/attention-is-all-you-need/attention-page-0.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Transformer 开山之作</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/butterflyblog/2025/04/25/LLM4Rec_abc_1/" title="大模型推荐系统（1）生成范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-25</div><div class="title">大模型推荐系统（1）生成范式</div></div></a></div><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_2/" title="大模型推荐系统（2）预训练范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/2/llm4rec-abc-2-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（2）预训练范式</div></div></a></div><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_4/" title="大模型推荐系统（4）直接推荐范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（4）直接推荐范式</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/T6.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">isSeymour</div><div class="author-info__description">志之所趋，无远弗届，穷山距海，不能限也。</div></div><div class="card-info-data site-data is-center"><a href="/butterflyblog/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/butterflyblog/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/butterflyblog/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/isSeymour/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://isSeymour.github.io/" target="_blank" title="学术主页"><i class="fa-regular fa-address-card" style="color: #000000;"></i></a><a class="social-icon" href="https://github.com/isSeymour/" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/79699613/" target="_blank" title="B站"><i class="fa-brands fa-bilibili" style="color: #000000;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_63205991/" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #000000;"></i></a><a class="social-icon" href="mailto:seymour0314@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">大模型在电商推荐中的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%86%B7%E5%90%AF%E5%8A%A8"><span class="toc-text">1、冷启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-text">1.1 数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%94%9F%E6%88%90%E5%86%B7%E5%90%AF%E5%8A%A8%E5%95%86%E5%93%81%E7%9A%84%E8%A1%8C%E4%B8%BA%E6%A0%B7%E6%9C%AC"><span class="toc-text">1.2 生成冷启动商品的行为样本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0%E8%83%BD%E5%8A%9B"><span class="toc-text">1.3 上下文学习能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83"><span class="toc-text">1.4 模型微调</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E6%A8%A1%E5%9E%8B%E6%95%88%E6%9E%9C%E8%AF%84%E4%BC%B0"><span class="toc-text">1.5 模型效果评估</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%94%9F%E6%88%90%E7%94%A8%E6%88%B7%E5%85%B4%E8%B6%A3%E7%94%BB%E5%83%8F"><span class="toc-text">2、生成用户兴趣画像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%94%9F%E6%88%90%E4%B8%AA%E6%80%A7%E5%8C%96%E5%95%86%E5%93%81%E6%8F%8F%E8%BF%B0"><span class="toc-text">3、生成个性化商品描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E7%8C%9C%E4%BD%A0%E5%96%9C%E6%AC%A2%E6%8E%A8%E8%8D%90"><span class="toc-text">4、猜你喜欢推荐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E7%94%B5%E5%95%86%E5%85%B3%E8%81%94%E6%8E%A8%E8%8D%90"><span class="toc-text">5、电商关联推荐</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-text">5.1 数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%A4%9A%E8%B7%AF%E5%8F%AC%E5%9B%9E"><span class="toc-text">5.2 多路召回</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%8E%92%E5%BA%8F"><span class="toc-text">5.3 相似度排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%95%88%E6%9E%9C%E8%AF%84%E4%BC%B0"><span class="toc-text">5.4 效果评估</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E6%8E%A8%E8%8D%90%E8%A7%A3%E9%87%8A"><span class="toc-text">6、推荐解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E5%AF%B9%E8%AF%9D%E5%BC%8F%E6%8E%A8%E8%8D%90"><span class="toc-text">7、对话式推荐</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/5/llm4rec-abc-5-Page.webp')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By isSeymour</div><div class="footer_custom_text">欢迎乘坐我的生活地铁！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/butterflyblog/js/utils.js"></script><script src="/butterflyblog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23liAZxomGv7Hapw8g',
      clientSecret: 'f7cafde192c4ada8bef4b76952c422d90575cf8b',
      repo: 'gitalk',
      owner: 'isSeymour',
      admin: ['isSeymour'],
      id: '1a025c13ec14b92551f6d0fd6cdd9c79',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/butterflyblog/js/search/local-search.js"></script></div></div></body></html>