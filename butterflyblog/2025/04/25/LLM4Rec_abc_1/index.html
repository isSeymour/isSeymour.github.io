<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>大模型推荐系统（1）生成范式 | isSeymour</title><meta name="author" content="isSeymour"><meta name="copyright" content="isSeymour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强 模型选用：  sentence-transformers&#x2F;all-MiniLM-L6-v2 数据集来源： MIND 新闻数据集对应论文MIND: A Large-scale Dataset for News Recommendation Amazon 电商数据集  注：大型文件包工具git-lfs、强化学习训练工具trl  生成">
<meta property="og:type" content="article">
<meta property="og:title" content="大模型推荐系统（1）生成范式">
<meta property="og:url" content="https://isseymour.github.io/butterflyblog/2025/04/25/LLM4Rec_abc_1/index.html">
<meta property="og:site_name" content="isSeymour">
<meta property="og:description" content="阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强 模型选用：  sentence-transformers&#x2F;all-MiniLM-L6-v2 数据集来源： MIND 新闻数据集对应论文MIND: A Large-scale Dataset for News Recommendation Amazon 电商数据集  注：大型文件包工具git-lfs、强化学习训练工具trl  生成">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png">
<meta property="article:published_time" content="2025-04-25T04:00:00.000Z">
<meta property="article:modified_time" content="2025-04-25T04:00:00.000Z">
<meta property="article:author" content="isSeymour">
<meta property="article:tag" content="LLM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/IC1011.ico"><link rel="canonical" href="https://isseymour.github.io/butterflyblog/2025/04/25/LLM4Rec_abc_1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/butterflyblog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/butterflyblog/',
  algolia: undefined,
  localSearch: {"path":"/butterflyblog/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '大模型推荐系统（1）生成范式',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-25 12:00:00'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/butterflyblog/code/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/T6.jpg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/butterflyblog/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/butterflyblog/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/butterflyblog/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> 总览</span></a></li><li><a class="site-page child" href="/butterflyblog/tags/"><i class="fa-fw fa-sharp fa-solid fa-hashtag"></i><span> 标签</span></a></li><li><a class="site-page child" href="/butterflyblog/categories/"><i class="fa-fw fa-sharp fa-solid fa-folder"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-list"></i><span> 功能</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/ctf/"><i class="fa-fw fa-solid fa-shield-halved"></i><span> CTF</span></a></li><li><a class="site-page child" href="/butterflyblog/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/butterflyblog/tools/"><i class="fa-fw fa-solid fa-screwdriver-wrench"></i><span> 下载</span></a></li><li><a class="site-page child" href="/butterflyblog/link/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-university"></i><span> 算法</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/algorithm/hot100/"><i class="fa-fw fa-solid fa-fire"></i><span> HOT100</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/labuladong/"><i class="fa-fw fa-solid fa-coffee"></i><span> labuladong</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/luogu/"><i class="fa-fw fa-solid fa-magnet"></i><span> 洛谷</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/template/"><i class="fa-fw fa-solid fa-code"></i><span> Template</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-plane"></i><span> 旅途</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/journey/Diary/"><i class="fa-fw fa-solid fa-book"></i><span> 日记本</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/BAOYAN/"><i class="fa-fw fa-solid fa-hashtag"></i><span> BAOYAN</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/english/"><i class="fa-fw fa-solid fa-globe"></i><span> 英语</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/mathAI/"><i class="fa-fw fa-solid fa-bar-chart"></i><span> 数学&amp;AI</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/RecSys/"><i class="fa-fw fa-solid fa-thumbs-up"></i><span> RecSys</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-regular fa-user"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/about/"><i class="fa-fw fa-regular fa-user"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/butterflyblog/message/"><i class="fa-fw fa-solid fa-message"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/butterflyblog/develop/"><i class="fa-fw fa-brands fa-windows"></i><span> 开发日志</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png')"><nav id="nav"><span id="blog-info"><a href="/butterflyblog/" title="isSeymour"><span class="site-name">isSeymour</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/archives/"><i class="fa-fw fa-solid fa-timeline"></i><span> 总览</span></a></li><li><a class="site-page child" href="/butterflyblog/tags/"><i class="fa-fw fa-sharp fa-solid fa-hashtag"></i><span> 标签</span></a></li><li><a class="site-page child" href="/butterflyblog/categories/"><i class="fa-fw fa-sharp fa-solid fa-folder"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-sharp fa-solid fa-list"></i><span> 功能</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/ctf/"><i class="fa-fw fa-solid fa-shield-halved"></i><span> CTF</span></a></li><li><a class="site-page child" href="/butterflyblog/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/butterflyblog/tools/"><i class="fa-fw fa-solid fa-screwdriver-wrench"></i><span> 下载</span></a></li><li><a class="site-page child" href="/butterflyblog/link/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 链接</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-university"></i><span> 算法</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/algorithm/hot100/"><i class="fa-fw fa-solid fa-fire"></i><span> HOT100</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/labuladong/"><i class="fa-fw fa-solid fa-coffee"></i><span> labuladong</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/luogu/"><i class="fa-fw fa-solid fa-magnet"></i><span> 洛谷</span></a></li><li><a class="site-page child" href="/butterflyblog/algorithm/template/"><i class="fa-fw fa-solid fa-code"></i><span> Template</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-plane"></i><span> 旅途</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/journey/Diary/"><i class="fa-fw fa-solid fa-book"></i><span> 日记本</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/BAOYAN/"><i class="fa-fw fa-solid fa-hashtag"></i><span> BAOYAN</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/english/"><i class="fa-fw fa-solid fa-globe"></i><span> 英语</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/mathAI/"><i class="fa-fw fa-solid fa-bar-chart"></i><span> 数学&amp;AI</span></a></li><li><a class="site-page child" href="/butterflyblog/journey/RecSys/"><i class="fa-fw fa-solid fa-thumbs-up"></i><span> RecSys</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-regular fa-user"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/butterflyblog/about/"><i class="fa-fw fa-regular fa-user"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/butterflyblog/message/"><i class="fa-fw fa-solid fa-message"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/butterflyblog/develop/"><i class="fa-fw fa-brands fa-windows"></i><span> 开发日志</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">大模型推荐系统（1）生成范式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-25T04:00:00.000Z" title="发表于 2025-04-25 12:00:00">2025-04-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-25T04:00:00.000Z" title="更新于 2025-04-25 12:00:00">2025-04-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/butterflyblog/categories/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/">推荐系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="大模型推荐系统（1）生成范式"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note danger no-icon flat"><p>阅读书籍: 《大模型推荐系统 | 算法原理、代码实战与案例分析》刘强<br>
模型选用：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2">sentence-transformers/all-MiniLM-L6-v2</a><br>
数据集来源：</li>
<li><a target="_blank" rel="noopener" href="https://msnews.github.io">MIND 新闻数据集</a>对应论文<a target="_blank" rel="noopener" href="https://msnews.github.io/assets/doc/ACL2020_MIND.pdf">MIND: A Large-scale Dataset for News Recommendation</a></li>
<li><a target="_blank" rel="noopener" href="https://cseweb.ucsd.edu/~jmcauley/datasets/amazon_v2/">Amazon 电商数据集</a></li>
</ul>
<p>注：大型文件包工具<a target="_blank" rel="noopener" href="https://git-lfs.com">git-lfs</a>、强化学习训练工具<a target="_blank" rel="noopener" href="https://github.com/huggingface/trl">trl</a></p>
</div>
<h1>生成范式</h1>
<blockquote>
<p>大模型生成特征、训练数据与物品</p>
</blockquote>
<h2 id="1、大模型生成嵌入特征">1、大模型生成嵌入特征</h2>
<h3 id="1-1-利用-sentence-transformers-框架嵌入">1.1 利用 sentence-transformers 框架嵌入</h3>
<ul>
<li>见下方代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">利用sentence_transformers框架来实现一个最简单的个性化推荐：</span></span><br><span class="line"><span class="string">1. 用户嵌入：用户浏览过的新闻的嵌入的平均值</span></span><br><span class="line"><span class="string">2. 预测：利用用户嵌入与新闻嵌入的cosine余弦</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer, util</span><br><span class="line"></span><br><span class="line">col_spliter = <span class="string">&quot;\t&quot;</span></span><br><span class="line">DIMS = <span class="number">384</span>  <span class="comment"># all-MiniLM-L6-v2 模型的维数</span></span><br><span class="line">TOP_N = <span class="number">10</span>  <span class="comment"># 为每个用户生成10个新闻推荐</span></span><br><span class="line"></span><br><span class="line">df_news = pd.read_csv(<span class="string">&quot;./data/mind/MINDsmall_train/news.tsv&quot;</span>, sep=col_spliter)</span><br><span class="line">df_news.columns = [<span class="string">&#x27;news_id&#x27;</span>, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;subcategory&#x27;</span>, <span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;abstract&#x27;</span>, <span class="string">&#x27;url&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;title_entity&#x27;</span>, <span class="string">&#x27;abstract_entity&#x27;</span>]</span><br><span class="line"></span><br><span class="line">df_behavior = pd.read_csv(<span class="string">&quot;./data/mind/MINDsmall_train/behaviors.tsv&quot;</span>, sep=col_spliter)</span><br><span class="line">df_behavior.columns = [<span class="string">&#x27;impression_id&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;click_history&#x27;</span>, <span class="string">&#x27;news&#x27;</span>]</span><br><span class="line"></span><br><span class="line">model = SentenceTransformer(<span class="string">&#x27;all-MiniLM-L6-v2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取每个新闻及对应的嵌入向量</span></span><br><span class="line">news_embeddings = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _, row <span class="keyword">in</span> df_news.iterrows():</span><br><span class="line">    news_id = row[<span class="string">&#x27;news_id&#x27;</span>]</span><br><span class="line">    title = row[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">    embedding = model.encode(title)</span><br><span class="line">    news_embeddings[news_id] = embedding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rec_4_one_user</span>(<span class="params">click_history</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    为单个用户生成 TOP_N 个推荐</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    emb = np.zeros(DIMS, dtype=<span class="built_in">float</span>)</span><br><span class="line">    <span class="keyword">for</span> news <span class="keyword">in</span> click_history:</span><br><span class="line">        emb = np.add(emb, news_embeddings[news])</span><br><span class="line">    emb = emb / <span class="built_in">len</span>(click_history)</span><br><span class="line">    emb = emb.astype(np.float32)</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> news_id, emb_ <span class="keyword">in</span> news_embeddings.items():</span><br><span class="line">        cos_sim = <span class="built_in">float</span>(util.cos_sim(emb, emb_)[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        res.append((news_id, cos_sim))</span><br><span class="line">    rec = <span class="built_in">sorted</span>(res, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[:TOP_N]</span><br><span class="line">    <span class="keyword">return</span> rec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">为所有用户生成推荐</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">user_rec = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _, row <span class="keyword">in</span> df_behavior.iterrows():</span><br><span class="line">    user_id = row[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line">    click_history = row[<span class="string">&#x27;click_history&#x27;</span>].split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    rec = rec_4_one_user(click_history)</span><br><span class="line">    user_rec[user_id] = rec</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>最终的输出结果基本符合要求，但是可能会在格式上出一点问题。</p>
</blockquote>
<h3 id="1-2-其他嵌入方法">1.2 其他嵌入方法</h3>
<ul>
<li>UNBERT</li>
<li>PREC</li>
</ul>
<h2 id="2、大模型生成文本特征">2、大模型生成文本特征</h2>
<h3 id="2-1-生成新闻标题">2.1 生成新闻标题</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks.manager <span class="keyword">import</span> CallbackManager</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks.streaming_stdout <span class="keyword">import</span> StreamingStdOutCallbackHandler</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> LlamaCpp</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">MIN_INTERVAL = <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新闻数据中包含的字段说明</span></span><br><span class="line">keys = <span class="built_in">dict</span>(</span><br><span class="line">    title=<span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">    abstract=<span class="string">&#x27;abs&#x27;</span>,</span><br><span class="line">    category=<span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">    subcategory=<span class="string">&#x27;subcat&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">current_path = os.getcwd()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将新闻读到dataframe中</span></span><br><span class="line">news_df = pd.read_csv(</span><br><span class="line">    filepath_or_buffer=os.path.join(current_path + <span class="string">&#x27;/data/news.tsv&#x27;</span>),</span><br><span class="line">    sep=<span class="string">&#x27;\t&#x27;</span>,</span><br><span class="line">    header=<span class="number">0</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建新闻列表，每一个元素是元组，元组前面是新闻id，后面是dict，dict是新闻相关信息, 下面是一条数据样本</span></span><br><span class="line"><span class="comment"># (&#x27;N55528&#x27;, &#123;&#x27;title&#x27;: &#x27;The Brands Queen Elizabeth, Prince Charles, and Prince Philip Swear By&#x27;,</span></span><br><span class="line"><span class="comment">#             &#x27;abstract&#x27;: &quot;Shop the notebooks, jackets, and more that the royals can&#x27;t live without.&quot;,</span></span><br><span class="line"><span class="comment">#             &#x27;category&#x27;: &#x27;lifestyle&#x27;, &#x27;subcategory&#x27;: &#x27;lifestyleroyals&#x27;, &#x27;newtitle&#x27;: &#x27;&#x27;&#125;)</span></span><br><span class="line">news_list = []</span><br><span class="line"><span class="keyword">for</span> news <span class="keyword">in</span> tqdm(news_df.iterrows()):</span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">        dic[key] = news[<span class="number">1</span>][keys[key]]</span><br><span class="line">    news_list.append((news[<span class="number">1</span>][<span class="string">&#x27;nid&#x27;</span>], dic))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提示词模板</span></span><br><span class="line">prompt_template = <span class="string">&quot;&quot;&quot;You are asked to act as a news title enhancer. I will provide you a piece of news, with its original title, category, subcategory, and abstract (if exists). The news format is as below:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[title] &#123;title&#125;</span></span><br><span class="line"><span class="string">[abstract] &#123;abstract&#125;</span></span><br><span class="line"><span class="string">[category] &#123;category&#125;</span></span><br><span class="line"><span class="string">[subcategory] &#123;subcategory&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">where title, abstract, category, and subcategory in the brace will be filled with content. You can only response a rephrased news title which should be clear, complete, objective and neutral. You can expand the title according to the above requirements. You are not allowed to response any other words for any explanation. Your response format should be:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[newtitle] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">where [newtitle] should be filled with the enhanced title. Now, your role of news title enhancer formally begins. Any other information should not disturb your role.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成的新的新闻标题的存储路径</span></span><br><span class="line">save_path = current_path + <span class="string">&#x27;/output/news_summarizer.log&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是调用LLAMA大模型的语法</span></span><br><span class="line">callback_manager = CallbackManager([StreamingStdOutCallbackHandler()])</span><br><span class="line">llm = LlamaCpp(</span><br><span class="line">    model_path=<span class="string">&quot;/Users/liuqiang/Desktop/code/llm/models/gguf/qwen1.5-72b-chat-q5_k_m.gguf&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0.8</span>,</span><br><span class="line">    top_p=<span class="number">0.8</span>,</span><br><span class="line">    n_ctx=<span class="number">6000</span>,</span><br><span class="line">    callback_manager=callback_manager,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># stop=[&quot;&lt;|im_end|&gt;&quot;]  # 生成的答案中遇到这些词就停止生成</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">PromptTemplate 与 chain的使用案例：</span></span><br><span class="line"><span class="string">（1）文本的使用方式</span></span><br><span class="line"><span class="string">prompt = PromptTemplate(</span></span><br><span class="line"><span class="string">    input_variables=[&quot;product&quot;],</span></span><br><span class="line"><span class="string">    template=&quot;What is a good name for a company that makes &#123;product&#125;?&quot;,</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chain = LLMChain(llm=llm, prompt=prompt)</span></span><br><span class="line"><span class="string"># Run the chain only specifying the input variable.</span></span><br><span class="line"><span class="string">print(chain.run(&quot;colorful socks&quot;))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（2）字典的使用方式</span></span><br><span class="line"><span class="string">prompt = PromptTemplate(</span></span><br><span class="line"><span class="string">    input_variables=[&quot;company&quot;, &quot;product&quot;],</span></span><br><span class="line"><span class="string">    template=&quot;What is a good name for &#123;company&#125; that makes &#123;product&#125;?&quot;,</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">chain = LLMChain(llm=llm, prompt=prompt)</span></span><br><span class="line"><span class="string">print(chain.run(&#123;</span></span><br><span class="line"><span class="string">    &#x27;company&#x27;: &quot;ABC Startup&quot;,</span></span><br><span class="line"><span class="string">    &#x27;product&#x27;: &quot;colorful socks&quot;</span></span><br><span class="line"><span class="string">    &#125;))</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;title&quot;</span>, <span class="string">&quot;abstract&quot;</span>, <span class="string">&quot;category&quot;</span>, <span class="string">&quot;subcategory&quot;</span>],</span><br><span class="line">    template=prompt_template,</span><br><span class="line">)</span><br><span class="line">chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先统计出哪些已经计算了，避免后面重复计算</span></span><br><span class="line">exist_set = <span class="built_in">set</span>()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="keyword">if</span> line <span class="keyword">and</span> line.startswith(<span class="string">&#x27;N&#x27;</span>):</span><br><span class="line">            exist_set.add(line.split(<span class="string">&#x27;\t&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用大模型迭代计算新闻标题</span></span><br><span class="line"><span class="keyword">for</span> nid, content <span class="keyword">in</span> tqdm(news_list):</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">if</span> nid <span class="keyword">in</span> exist_set:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        title = content[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        abstract = content[<span class="string">&#x27;abstract&#x27;</span>]</span><br><span class="line">        category = content[<span class="string">&#x27;category&#x27;</span>]</span><br><span class="line">        subcategory = content[<span class="string">&#x27;subcategory&#x27;</span>]</span><br><span class="line">        enhanced = chain.run(title=title, abstract=abstract, category=category, subcategory=subcategory)</span><br><span class="line">        enhanced = enhanced.rstrip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">f&#x27;<span class="subst">&#123;nid&#125;</span>\t<span class="subst">&#123;enhanced&#125;</span>\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">    interval = time.time() - start_time</span><br><span class="line">    <span class="keyword">if</span> interval &lt;= MIN_INTERVAL:</span><br><span class="line">        time.sleep(MIN_INTERVAL - interval)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-2-生成用户兴趣画像">2.2 生成用户兴趣画像</h3>
<p>文件<code>prompter.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> UniTok <span class="keyword">import</span> UniDep</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MindPrompter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_path</span>):</span><br><span class="line">        self.data_path = data_path</span><br><span class="line"></span><br><span class="line">        self.news_df = pd.read_csv(</span><br><span class="line">            filepath_or_buffer=os.path.join(data_path),</span><br><span class="line">            sep=<span class="string">&#x27;\t&#x27;</span>,</span><br><span class="line">            header=<span class="number">0</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.keys = <span class="built_in">dict</span>(</span><br><span class="line">            title=<span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            abstract=<span class="string">&#x27;abs&#x27;</span>,</span><br><span class="line">            category=<span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">            subcategory=<span class="string">&#x27;subcat&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self._news_list = <span class="literal">None</span></span><br><span class="line">        self._news_dict = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._news_list <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._news_list</span><br><span class="line">        self._news_list = []</span><br><span class="line">        <span class="keyword">for</span> news <span class="keyword">in</span> tqdm(self.news_df.iterrows()):</span><br><span class="line">            string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> self.keys:</span><br><span class="line">                string += <span class="string">f&#x27;[<span class="subst">&#123;key&#125;</span>] <span class="subst">&#123;news[<span class="number">1</span>][self.keys[key]]&#125;</span>\n&#x27;</span></span><br><span class="line">            self._news_list.append((news[<span class="number">1</span>][<span class="string">&#x27;nid&#x27;</span>], string))</span><br><span class="line">        <span class="keyword">return</span> self._news_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_news_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._news_dict <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._news_dict</span><br><span class="line">        self._news_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> news <span class="keyword">in</span> tqdm(self.news_df.iterrows()):</span><br><span class="line">            self._news_dict[news[<span class="number">1</span>][<span class="string">&#x27;nid&#x27;</span>]] = news[<span class="number">1</span>][<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> self._news_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_news_dict_with_category</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._news_dict <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._news_dict</span><br><span class="line">        self._news_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> news <span class="keyword">in</span> tqdm(self.news_df.iterrows()):</span><br><span class="line">            self._news_dict[news[<span class="number">1</span>][<span class="string">&#x27;nid&#x27;</span>]] = <span class="string">f&#x27;(<span class="subst">&#123;news[<span class="number">1</span>][<span class="string">&quot;cat&quot;</span>]&#125;</span>) <span class="subst">&#123;news[<span class="number">1</span>][<span class="string">&quot;title&quot;</span>]&#125;</span>&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> self._news_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MindUser</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_path, mind_prompter</span>):</span><br><span class="line">        self.depot = UniDep(data_path, silent=<span class="literal">True</span>)</span><br><span class="line">        self.nid = self.depot.vocabs(<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">        self.news_dict = mind_prompter.get_news_dict()</span><br><span class="line"></span><br><span class="line">        self._user_list = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._user_list <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._user_list</span><br><span class="line">        self._user_list = []</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> tqdm(self.depot):</span><br><span class="line">            string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user[<span class="string">&#x27;history&#x27;</span>]:</span><br><span class="line">                self._user_list.append((user[<span class="string">&#x27;uid&#x27;</span>], <span class="literal">None</span>))</span><br><span class="line">            <span class="keyword">for</span> i, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(user[<span class="string">&#x27;history&#x27;</span>]):</span><br><span class="line">                string += <span class="string">f&#x27;(<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>) <span class="subst">&#123;self.news_dict[self.nid.i2o[n]]&#125;</span>\n&#x27;</span></span><br><span class="line">            self._user_list.append((user[<span class="string">&#x27;uid&#x27;</span>], string))</span><br><span class="line">        <span class="keyword">return</span> self._user_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MindColdUser</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_path, mind_prompter</span>):</span><br><span class="line">        self.depot = UniDep(data_path, silent=<span class="literal">True</span>)</span><br><span class="line">        self.nid = self.depot.vocabs(<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">        self.news_dict = mind_prompter.get_news_dict_with_category()</span><br><span class="line"></span><br><span class="line">        self._user_list = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._user_list <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._user_list</span><br><span class="line">        self._user_list = []</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> tqdm(self.depot):</span><br><span class="line">            string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user[<span class="string">&#x27;history&#x27;</span>] <span class="keyword">or</span> <span class="built_in">len</span>(user[<span class="string">&#x27;history&#x27;</span>]) &gt; <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> i, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(user[<span class="string">&#x27;history&#x27;</span>]):</span><br><span class="line">                string += <span class="string">f&#x27;(<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>) <span class="subst">&#123;self.news_dict[self.nid.i2o[n]]&#125;</span>\n&#x27;</span></span><br><span class="line">            self._user_list.append((user[<span class="string">&#x27;uid&#x27;</span>], string))</span><br><span class="line">        <span class="keyword">return</span> self._user_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MindCoT</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_path, plugin_path, mind_prompter, allowed_user_path</span>):</span><br><span class="line">        self.depot = UniDep(data_path, silent=<span class="literal">True</span>)</span><br><span class="line">        self.plugin = UniDep(plugin_path, silent=<span class="literal">True</span>)</span><br><span class="line">        self.tv = self.plugin.vocabs[<span class="string">&#x27;topic&#x27;</span>]</span><br><span class="line">        self.rv = self.plugin.vocabs[<span class="string">&#x27;region&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        self.nid = self.depot.vocabs(<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">        self.news_dict = mind_prompter.get_news_dict_with_category()</span><br><span class="line"></span><br><span class="line">        self._user_list = <span class="literal">None</span></span><br><span class="line">        self.allowed_user = json.load(<span class="built_in">open</span>(allowed_user_path))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stringify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._user_list <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self._user_list</span><br><span class="line">        self._user_list = []</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> tqdm(self.depot):</span><br><span class="line">            <span class="keyword">if</span> user[<span class="string">&#x27;uid&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> self.allowed_user:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            pg = self.plugin[user[<span class="string">&#x27;uid&#x27;</span>]]</span><br><span class="line">            string += <span class="string">&#x27;Interest Topics:\n&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> pg[<span class="string">&#x27;topic&#x27;</span>]:</span><br><span class="line">                string += <span class="string">f&#x27;- <span class="subst">&#123;self.tv[t]&#125;</span>\n&#x27;</span></span><br><span class="line">            string += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">            <span class="comment"># string += &#x27;Interest Regions:\n&#x27;</span></span><br><span class="line">            <span class="comment"># for r in pg[&#x27;region&#x27;]:</span></span><br><span class="line">            <span class="comment">#     string += f&#x27;- &#123;self.rv[r]&#125;\n&#x27;</span></span><br><span class="line">            <span class="comment"># string += &#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">            string += <span class="string">&#x27;History:\n&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> i, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(user[<span class="string">&#x27;history&#x27;</span>]):</span><br><span class="line">                string += <span class="string">f&#x27;(<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>) <span class="subst">&#123;self.news_dict[self.nid.i2o[n]]&#125;</span>\n&#x27;</span></span><br><span class="line">            self._user_list.append((user[<span class="string">&#x27;uid&#x27;</span>], string))</span><br><span class="line">        <span class="keyword">return</span> self._user_list</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主文件<code>user_portrait.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> UniTok <span class="keyword">import</span> UniDep</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks.manager <span class="keyword">import</span> CallbackManager</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks.streaming_stdout <span class="keyword">import</span> StreamingStdOutCallbackHandler</span><br><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> LlamaCpp</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> prompter <span class="keyword">import</span> MindPrompter, MindUser</span><br><span class="line"></span><br><span class="line">MIN_INTERVAL = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">current_path = os.getcwd()</span><br><span class="line"></span><br><span class="line">mind_prompter = MindPrompter(current_path + <span class="string">&#x27;/data/news.tsv&#x27;</span>)</span><br><span class="line">user_list = MindUser(current_path + <span class="string">&#x27;/data/user&#x27;</span>, mind_prompter).stringify()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将新闻读到dataframe中</span></span><br><span class="line">news_df = pd.read_csv(</span><br><span class="line">    filepath_or_buffer=os.path.join(current_path + <span class="string">&#x27;/data/news.tsv&#x27;</span>),</span><br><span class="line">    sep=<span class="string">&#x27;\t&#x27;</span>,</span><br><span class="line">    header=<span class="number">0</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建新闻字典，key为新闻id，value为新闻的title</span></span><br><span class="line">news_dict = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> news <span class="keyword">in</span> tqdm(news_df.iterrows()):</span><br><span class="line">    news_dict[news[<span class="number">1</span>][<span class="string">&#x27;nid&#x27;</span>]] = news[<span class="number">1</span>][<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line"></span><br><span class="line">depot = UniDep(current_path + <span class="string">&#x27;/data/user&#x27;</span>, silent=<span class="literal">True</span>)</span><br><span class="line">nid = depot.vocabs(<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成每个用户及他看过的新闻数据，下面是一条案例</span></span><br><span class="line"><span class="comment"># (0, [&quot;&#x27;Wheel Of Fortune&#x27; Guest Delivers Hilarious, Off The Rails Introduction&quot;,</span></span><br><span class="line"><span class="comment"># &quot;Three takeaways from Yankees&#x27; ALCS Game 5 victory over the Astros&quot;,</span></span><br><span class="line"><span class="comment"># &quot;Rosie O&#x27;Donnell: Barbara Walters Isn&#x27;t &#x27;Up to Speaking to People&#x27; Right Now&quot;,</span></span><br><span class="line"><span class="comment"># &quot;Four flight attendants were arrested in Miami&#x27;s airport after bringing in thousands in cash, police say&quot;,</span></span><br><span class="line"><span class="comment"># &#x27;Michigan sends breakup tweet to Notre Dame as series goes on hold&#x27;,</span></span><br><span class="line"><span class="comment"># &quot;This Wedding Photo of a Canine Best Man Captures Just How Deep a Dog&#x27;s Love Truly Is&quot;,</span></span><br><span class="line"><span class="comment"># &quot;Robert Evans, &#x27;Chinatown&#x27; Producer and Paramount Chief, Dies at 89&quot;,</span></span><br><span class="line"><span class="comment"># &#x27;Former US Senator Kay Hagan dead at 66&#x27;,</span></span><br><span class="line"><span class="comment"># &#x27;Joe Biden reportedly denied Communion at a South Carolina church because of his stance on abortion&#x27;])</span></span><br><span class="line"><span class="comment"># user_list = []</span></span><br><span class="line"><span class="comment"># for user in tqdm(depot):</span></span><br><span class="line"><span class="comment">#     list = []</span></span><br><span class="line"><span class="comment">#     if not user[&#x27;history&#x27;]:</span></span><br><span class="line"><span class="comment">#         user_list.append((user[&#x27;uid&#x27;], None))</span></span><br><span class="line"><span class="comment">#     for i, n in enumerate(user[&#x27;history&#x27;]):</span></span><br><span class="line"><span class="comment">#         list.append(news_dict[nid.i2o[n]])</span></span><br><span class="line"><span class="comment">#     user_list.append((user[&#x27;uid&#x27;], list))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提示词模板</span></span><br><span class="line">system = <span class="string">&quot;&quot;&quot;You are asked to describe user interest based on his/her browsed news title list, the format of which is as below:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;input&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can only response the user interests with the following format to describe the [topics] and [regions] of the user&#x27;s interest</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[topics]</span></span><br><span class="line"><span class="string">- topic1</span></span><br><span class="line"><span class="string">- topic2</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">[region] (optional)</span></span><br><span class="line"><span class="string">- region1</span></span><br><span class="line"><span class="string">- region2</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">where topic is limited to the following options: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(1) health</span></span><br><span class="line"><span class="string">(2) education</span></span><br><span class="line"><span class="string">(3) travel</span></span><br><span class="line"><span class="string">(4) religion</span></span><br><span class="line"><span class="string">(5) culture</span></span><br><span class="line"><span class="string">(6) food</span></span><br><span class="line"><span class="string">(7) fashion</span></span><br><span class="line"><span class="string">(8) technology</span></span><br><span class="line"><span class="string">(9) social media</span></span><br><span class="line"><span class="string">(10) gender and sexuality</span></span><br><span class="line"><span class="string">(11) race and ethnicity</span></span><br><span class="line"><span class="string">(12) history</span></span><br><span class="line"><span class="string">(13) economy</span></span><br><span class="line"><span class="string">(14) finance</span></span><br><span class="line"><span class="string">(15) real estate</span></span><br><span class="line"><span class="string">(16) transportation</span></span><br><span class="line"><span class="string">(17) weather</span></span><br><span class="line"><span class="string">(18) disasters</span></span><br><span class="line"><span class="string">(19) international news</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">and the region should be limited to each state of the US.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Only [topics] and [region] can be appeared in your response. If you think region are hard to predict, leave it blank. Your response topic/region list should be ordered, that the first several options should be most related to the user&#x27;s interest. You are not allowed to response any other words for any explanation or note. Now, the task formally begins. Any other information should not disturb you.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成的用户兴趣画像的存储路径</span></span><br><span class="line">save_path = current_path + <span class="string">&#x27;/output/user_profiler.log&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是调用LLAMA大模型的语法</span></span><br><span class="line">callback_manager = CallbackManager([StreamingStdOutCallbackHandler()])</span><br><span class="line">llm = LlamaCpp(</span><br><span class="line">    model_path=<span class="string">&quot;/Users/liuqiang/Desktop/code/llm/models/gguf/qwen1.5-72b-chat-q5_k_m.gguf&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0.8</span>,</span><br><span class="line">    top_p=<span class="number">0.8</span>,</span><br><span class="line">    n_ctx=<span class="number">6000</span>,</span><br><span class="line">    callback_manager=callback_manager,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先统计出哪些已经计算了，避免后面重复计算</span></span><br><span class="line">exist_set = <span class="built_in">set</span>()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        data = json.loads(line)</span><br><span class="line">        exist_set.add(data[<span class="string">&#x27;uid&#x27;</span>])</span><br><span class="line"></span><br><span class="line">empty_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用大模型迭代计算用户兴趣画像</span></span><br><span class="line"><span class="keyword">for</span> uid, content <span class="keyword">in</span> tqdm(user_list):</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">if</span> uid <span class="keyword">in</span> exist_set:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> content:</span><br><span class="line">        empty_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        prompt = PromptTemplate(</span><br><span class="line">            input_variables=[<span class="string">&quot;input&quot;</span>],</span><br><span class="line">            template=system,</span><br><span class="line">        )</span><br><span class="line">        chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line">        enhanced = chain.run(<span class="built_in">input</span>=content)</span><br><span class="line">        enhanced = enhanced.rstrip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(json.dumps(&#123;<span class="string">&#x27;uid&#x27;</span>: uid, <span class="string">&#x27;interest&#x27;</span>: enhanced&#125;) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">    interval = time.time() - start_time</span><br><span class="line">    <span class="keyword">if</span> interval &lt;= MIN_INTERVAL:</span><br><span class="line">        time.sleep(MIN_INTERVAL - interval)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;empty count: &#x27;</span>, empty_count)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果满足要求，但是会发现可能有 topic 根本不在要求范围内（大模型产生的幻觉）<br>
可能需要优化提示词等。</p>
</blockquote>
<h3 id="2-3-生成文本特征的其他方法">2.3 生成文本特征的其他方法</h3>
<ul>
<li>RLMRec 生成物品与用户画像</li>
<li>PALR 框架生成用户兴趣画像</li>
</ul>
<h2 id="3、大模型生成训练数据">3、大模型生成训练数据</h2>
<h3 id="3-1-直接生成表格类数据">3.1 直接生成表格类数据</h3>
<p>方法：GReaT</p>
<h3 id="3-2-生成监督样本数据">3.2 生成监督样本数据</h3>
<p>方法：基于开源的数据集，通过 GPT-4 获得对应的答案，即获得<code>&lt;输入,输出&gt;</code> 样本对，就是可用于微调的监督样本。<br>
（实际使用时，还需借助人工抽查、规则策略、置信度评分等手段提升质量）</p>
<h2 id="4、大模型生成待推荐物品">4、大模型生成待推荐物品</h2>
<h3 id="4-1-生成个性化新闻">4.1 生成个性化新闻</h3>
<ol>
<li>生成用户喜欢的新闻类型、标题</li>
<li>基于 1 生成满足用户个性化需求的新闻</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks.manager <span class="keyword">import</span> CallbackManager</span><br><span class="line"><span class="keyword">from</span> langchain.callbacks.streaming_stdout <span class="keyword">import</span> StreamingStdOutCallbackHandler</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms <span class="keyword">import</span> LlamaCpp</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">MIN_INTERVAL = <span class="number">0</span></span><br><span class="line">current_path = os.getcwd()</span><br><span class="line"></span><br><span class="line">save_path = current_path + <span class="string">&#x27;/output/personalized_news.log&#x27;</span></span><br><span class="line"></span><br><span class="line">prompt_template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">you are a news writing expert, The information of the news a user browsed are as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;news&quot;: &#123;news&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The news in the curly braces above are a list of all the news that the user has browsed, which may contain multiple news articles.</span></span><br><span class="line"><span class="string">the information in the news stand for the category of news the user likes.</span></span><br><span class="line"><span class="string">Now please write a new for the user, the news must relevant to the interest of the user, the news you write must less than 300 words.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是调用LLAMA大模型的语法</span></span><br><span class="line">callback_manager = CallbackManager([StreamingStdOutCallbackHandler()])</span><br><span class="line">llm = LlamaCpp(</span><br><span class="line">    model_path=<span class="string">&quot;/Users/liuqiang/Desktop/code/llm/models/gguf/qwen1.5-72b-chat-q5_k_m.gguf&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0.8</span>,</span><br><span class="line">    top_p=<span class="number">0.8</span>,</span><br><span class="line">    n_ctx=<span class="number">6000</span>,</span><br><span class="line">    callback_manager=callback_manager,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;news&quot;</span>],</span><br><span class="line">    template=prompt_template,</span><br><span class="line">)</span><br><span class="line">chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先统计出哪些已经计算了，避免后面重复计算</span></span><br><span class="line">exist_set = <span class="built_in">set</span>()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        data = json.loads(line)</span><br><span class="line">        exist_set.add(data[<span class="string">&#x27;uid&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开文件并创建文件对象</span></span><br><span class="line">file = <span class="built_in">open</span>(current_path + <span class="string">&#x27;/output/personalized_news_summary.log&#x27;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 readlines() 方法将文件内容按行存入列表 lines</span></span><br><span class="line">lines = file.readlines()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭文件</span></span><br><span class="line">file.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出文件内容</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> tqdm(lines):</span><br><span class="line">    info = <span class="built_in">eval</span>(line)</span><br><span class="line">    uid = info[<span class="string">&#x27;uid&#x27;</span>]</span><br><span class="line">    news = info[<span class="string">&#x27;news&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">if</span> uid <span class="keyword">in</span> exist_set:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> news:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        enhanced = chain.run(news)</span><br><span class="line">        enhanced = enhanced.rstrip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        news_ = &#123;<span class="string">&quot;uid&quot;</span>: uid, <span class="string">&quot;news&quot;</span>: enhanced&#125;</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">str</span>(news_)&#125;</span>\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">    interval = time.time() - start_time</span><br><span class="line">    <span class="keyword">if</span> interval &lt;= MIN_INTERVAL:</span><br><span class="line">        time.sleep(MIN_INTERVAL - interval)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-2-生成个性化的视频">4.2 生成个性化的视频</h3>
<ul>
<li>剪辑或新生成小视频</li>
<li>个性化缩略图选择与生成任务（根据过去喜欢的特征、扩散模型）</li>
<li>长视频使用 CLIP 技术进行个性化剪辑，只推荐用户喜欢的部分</li>
<li>视频风格迁移</li>
<li>使用 MCVD 技术进行视频编辑调整</li>
<li>基于文本生成小视频（MCVD技术）</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://isSeymour.github.io/butterflyblog">isSeymour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://isseymour.github.io/butterflyblog/2025/04/25/LLM4Rec_abc_1/">https://isseymour.github.io/butterflyblog/2025/04/25/LLM4Rec_abc_1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://isSeymour.github.io/butterflyblog" target="_blank">isSeymour</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/butterflyblog/tags/LLM/">LLM</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY1.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY1.jpg" alt="微信支付"/></a><div class="post-qr-code-desc">微信支付</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY2.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/pay/PAY2.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/butterflyblog/2024/10/14/CS224W_Colab_2/" title="CS224W - Colab 2"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/CS224W/GCN/shared-parameters.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CS224W - Colab 2</div></div></a></div><div class="next-post pull-right"><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_2/" title="大模型推荐系统（2）预训练范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/2/llm4rec-abc-2-Page.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">大模型推荐系统（2）预训练范式</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_2/" title="大模型推荐系统（2）预训练范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/2/llm4rec-abc-2-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（2）预训练范式</div></div></a></div><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_4/" title="大模型推荐系统（4）直接推荐范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/4/llm4rec-abc-4-Page.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（4）直接推荐范式</div></div></a></div><div><a href="/butterflyblog/2025/04/26/LLM4Rec_abc_3/" title="大模型推荐系统（3）微调范式"><img class="cover" src="https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/3/llm4rec-abc-3-Page.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class="title">大模型推荐系统（3）微调范式</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/T6.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/Seymour0314/PicGo/blog/page_img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">isSeymour</div><div class="author-info__description">志之所趋，无远弗届，穷山距海，不能限也。</div></div><div class="card-info-data site-data is-center"><a href="/butterflyblog/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/butterflyblog/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/butterflyblog/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/isSeymour/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://isSeymour.github.io/" target="_blank" title="学术主页"><i class="fa-regular fa-address-card" style="color: #000000;"></i></a><a class="social-icon" href="https://github.com/isSeymour/" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/79699613/" target="_blank" title="B站"><i class="fa-brands fa-bilibili" style="color: #000000;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_63205991/" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #000000;"></i></a><a class="social-icon" href="mailto:seymour0314@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">生成范式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%94%9F%E6%88%90%E5%B5%8C%E5%85%A5%E7%89%B9%E5%BE%81"><span class="toc-text">1、大模型生成嵌入特征</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%88%A9%E7%94%A8-sentence-transformers-%E6%A1%86%E6%9E%B6%E5%B5%8C%E5%85%A5"><span class="toc-text">1.1 利用 sentence-transformers 框架嵌入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%85%B6%E4%BB%96%E5%B5%8C%E5%85%A5%E6%96%B9%E6%B3%95"><span class="toc-text">1.2 其他嵌入方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%94%9F%E6%88%90%E6%96%87%E6%9C%AC%E7%89%B9%E5%BE%81"><span class="toc-text">2、大模型生成文本特征</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%94%9F%E6%88%90%E6%96%B0%E9%97%BB%E6%A0%87%E9%A2%98"><span class="toc-text">2.1 生成新闻标题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%94%9F%E6%88%90%E7%94%A8%E6%88%B7%E5%85%B4%E8%B6%A3%E7%94%BB%E5%83%8F"><span class="toc-text">2.2 生成用户兴趣画像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%94%9F%E6%88%90%E6%96%87%E6%9C%AC%E7%89%B9%E5%BE%81%E7%9A%84%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95"><span class="toc-text">2.3 生成文本特征的其他方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%94%9F%E6%88%90%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE"><span class="toc-text">3、大模型生成训练数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%9B%B4%E6%8E%A5%E7%94%9F%E6%88%90%E8%A1%A8%E6%A0%BC%E7%B1%BB%E6%95%B0%E6%8D%AE"><span class="toc-text">3.1 直接生成表格类数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%94%9F%E6%88%90%E7%9B%91%E7%9D%A3%E6%A0%B7%E6%9C%AC%E6%95%B0%E6%8D%AE"><span class="toc-text">3.2 生成监督样本数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%94%9F%E6%88%90%E5%BE%85%E6%8E%A8%E8%8D%90%E7%89%A9%E5%93%81"><span class="toc-text">4、大模型生成待推荐物品</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%94%9F%E6%88%90%E4%B8%AA%E6%80%A7%E5%8C%96%E6%96%B0%E9%97%BB"><span class="toc-text">4.1 生成个性化新闻</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%94%9F%E6%88%90%E4%B8%AA%E6%80%A7%E5%8C%96%E7%9A%84%E8%A7%86%E9%A2%91"><span class="toc-text">4.2 生成个性化的视频</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/isSeymour/PicGo/posts/llm4rec_abc/1/llm4rec-abc-1-Page.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By isSeymour</div><div class="footer_custom_text">欢迎乘坐我的生活地铁！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/butterflyblog/js/utils.js"></script><script src="/butterflyblog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23liAZxomGv7Hapw8g',
      clientSecret: 'f7cafde192c4ada8bef4b76952c422d90575cf8b',
      repo: 'gitalk',
      owner: 'isSeymour',
      admin: ['isSeymour'],
      id: 'c107490ec9eaf31302f0b96edda287a2',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/butterflyblog/js/search/local-search.js"></script></div></div></body></html>